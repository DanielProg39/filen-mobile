{"ast":null,"code":"import _regeneratorRuntime from\"/Users/jan/Documents/filen/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/jan/Documents/filen/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import*as language from\"../utils/language\";import*as workers from\"../utils/workers\";import{Capacitor,Plugins}from\"@capacitor/core\";var utils=require(\"../utils/utils\");export function fileExists(_x,_x2,_x3){return _fileExists.apply(this,arguments);}function _fileExists(){_fileExists=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(name,parent,callback){var res;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(parent==null){parent=\"default\";}_context.prev=1;_context.next=4;return utils.apiRequest(\"POST\",\"/v1/file/exists\",{apiKey:this.state.userAPIKey,parent:parent,nameHashed:utils.hashFn(name.toLowerCase())});case 4:res=_context.sent;_context.next=10;break;case 7:_context.prev=7;_context.t0=_context[\"catch\"](1);return _context.abrupt(\"return\",callback(_context.t0));case 10:if(res.status){_context.next=12;break;}return _context.abrupt(\"return\",callback(res.message));case 12:return _context.abrupt(\"return\",callback(null,res.data.exists,res.data.uuid));case 13:case\"end\":return _context.stop();}}},_callee,this,[[1,7]]);}));return _fileExists.apply(this,arguments);}export function markUploadAsDone(_x4,_x5,_x6,_x7,_x8){return _markUploadAsDone.apply(this,arguments);}function _markUploadAsDone(){_markUploadAsDone=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(uuid,uploadKey,tries,maxTries,callback){var _this=this;var res;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(tries>=maxTries)){_context2.next=2;break;}return _context2.abrupt(\"return\",callback(new Error(\"mark upload as done max tries reached, returning.\")));case 2:_context2.prev=2;_context2.next=5;return utils.apiRequest(\"POST\",\"/v1/upload/done\",{uuid:uuid,uploadKey:uploadKey});case 5:res=_context2.sent;_context2.next=12;break;case 8:_context2.prev=8;_context2.t0=_context2[\"catch\"](2);console.log(_context2.t0);return _context2.abrupt(\"return\",setTimeout(function(){_this.markUploadAsDone(uuid,uploadKey,tries+1,maxTries,callback);},1000));case 12:if(res.status){_context2.next=15;break;}console.log(res.message);return _context2.abrupt(\"return\",callback(res.message));case 15:return _context2.abrupt(\"return\",callback(null));case 16:case\"end\":return _context2.stop();}}},_callee2,null,[[2,8]]);}));return _markUploadAsDone.apply(this,arguments);}export function uploadChunk(_x9,_x10,_x11,_x12,_x13,_x14,_x15){return _uploadChunk.apply(this,arguments);}function _uploadChunk(){_uploadChunk=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(uuid,file,queryParams,data,tries,maxTries,callback){var _this2=this;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.next=2;return window.customVariables.uploadChunkSemaphore.acquire();case 2:if(!(typeof window.customVariables.stoppedUploads[uuid]!==\"undefined\")){_context3.next=4;break;}return _context3.abrupt(\"return\",callback(\"stopped\"));case 4:fetch(utils.getUploadServer()+\"/v1/upload?\"+queryParams,{method:\"POST\",cache:\"no-cache\",body:data}).then(function(response){response.json().then(function(obj){var res=obj;window.customVariables.uploadChunkSemaphore.release();if(typeof window.customVariables.stoppedUploads[uuid]!==\"undefined\"){return callback(\"stopped\");}if(!res){return setTimeout(function(){_this2.uploadChunk(uuid,file,queryParams,data,tries+1,maxTries,callback);},1000);}else{if(typeof res!==\"object\"){return setTimeout(function(){_this2.uploadChunk(uuid,file,queryParams,data,tries+1,maxTries,callback);},1000);}else{if(!res.status){return callback(res.message);}else{return callback(null,res,utils.parseQuery(queryParams));}}}}).catch(function(err){console.log(err);window.customVariables.uploadChunkSemaphore.release();return setTimeout(function(){_this2.uploadChunk(uuid,file,queryParams,data,tries+1,maxTries,callback);},1000);});}).catch(function(err){console.log(err);window.customVariables.uploadChunkSemaphore.release();return setTimeout(function(){_this2.uploadChunk(uuid,file,queryParams,data,tries+1,maxTries,callback);},1000);});case 5:case\"end\":return _context3.stop();}}},_callee3);}));return _uploadChunk.apply(this,arguments);}export function queueFileUpload(_x16){return _queueFileUpload.apply(this,arguments);}function _queueFileUpload(){_queueFileUpload=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(file){var _this3=this;var networkStatus,parent,fileNameEx,lowerCaseFileEnding,fileNameWithLowerCaseEnding;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:if(!Capacitor.isNative){_context6.next=7;break;}if(!this.state.settings.onlyWifi){_context6.next=7;break;}_context6.next=4;return Plugins.Network.getStatus();case 4:networkStatus=_context6.sent;if(!(networkStatus.connectionType!==\"wifi\")){_context6.next=7;break;}return _context6.abrupt(\"return\",this.spawnToast(language.get(this.state.lang,\"onlyWifiError\")));case 7:if(!(file.size<=0)){_context6.next=9;break;}return _context6.abrupt(\"return\",this.spawnToast(language.get(this.state.lang,\"uploadInvalidFileSize\",true,[\"__NAME__\"],[file.name])));case 9:parent=utils.currentParentFolder();if(file.name.indexOf(\".\")!==-1){fileNameEx=file.name.split(\".\");lowerCaseFileEnding=fileNameEx[fileNameEx.length-1].toLowerCase();fileNameEx.pop();fileNameWithLowerCaseEnding=fileNameEx.join(\".\")+\".\"+lowerCaseFileEnding;Object.defineProperty(file,\"name\",{writable:true,value:utils.removeIllegalCharsFromString(fileNameWithLowerCaseEnding)});}if(!(utils.nameRegex(file.name)||utils.checkIfNameIsBanned(file.name)||utils.fileNameValidationRegex(file.name))){_context6.next=13;break;}return _context6.abrupt(\"return\",this.spawnToast(language.get(this.state.lang,\"fileUploadInvalidFileName\",true,[\"__NAME__\"],[file.name])));case 13:this.fileExists(file.name,parent,/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(err,exists,existsUUID){var name,mime,size,uuid,key,rm,uploadKey,expire,chunkSizeToUse,dummyOffset,fileChunks,offset,currentIndex,nameEnc,nameH,mimeEnc,sizeEnc,metaData,firstDone,doFirst,markedAsDone,chunksUploaded,addToState,removeFromState,setProgress,setLoaded,uploadInterval;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(!err){_context5.next=2;break;}return _context5.abrupt(\"return\",_this3.spawnToast(language.get(_this3.state.lang,\"apiRequestError\")));case 2:if(!exists){_context5.next=4;break;}return _context5.abrupt(\"return\",_this3.spawnToast(language.get(_this3.state.lang,\"fileUploadFileAlreadyExists\",true,[\"__NAME__\"],[file.name])));case 4:name=file.name;mime=file.type;size=file.size;uuid=utils.uuidv4();key=utils.generateRandomString(32);rm=utils.generateRandomString(32);uploadKey=utils.generateRandomString(32);expire=\"never\";chunkSizeToUse=1024*1024*1;dummyOffset=0;fileChunks=0;while(dummyOffset<file.size){fileChunks++;dummyOffset+=chunkSizeToUse;}offset=0-chunkSizeToUse;currentIndex=-1;nameEnc=utils.cryptoJSEncrypt(name,key);nameH=utils.hashFn(name.toLowerCase());mimeEnc=utils.cryptoJSEncrypt(mime,key);sizeEnc=utils.cryptoJSEncrypt(size.toString(),key);metaData=utils.cryptoJSEncrypt(JSON.stringify({name:name,size:size,mime:mime,key:key}),_this3.state.userMasterKeys[_this3.state.userMasterKeys.length-1]);firstDone=false;doFirst=true;markedAsDone=false;chunksUploaded=0;window.customVariables.stoppedUploads[uuid]=undefined;window.customVariables.stoppedUploadsDone[uuid]=undefined;addToState=function addToState(){var currentUploads=_this3.state.uploads;currentUploads[uuid]={uuid:uuid,size:size,chunks:fileChunks,loaded:0,progress:0,name:name};window.customVariables.uploads[uuid]={uuid:uuid,size:size,chunks:fileChunks,loaded:0,progress:0,name:name};return _this3.setState({uploads:currentUploads,uploadsCount:_this3.state.uploadsCount+1});};removeFromState=function removeFromState(){var currentUploads=_this3.state.uploads;delete currentUploads[uuid];delete window.customVariables.uploads[uuid];return _this3.setState({uploads:currentUploads,uploadsCount:_this3.state.uploadsCount-1});};setProgress=function setProgress(progress){try{var currentUploads=_this3.state.uploads;currentUploads[uuid].progress=progress;window.customVariables.uploads[uuid].progress=progress;return _this3.setState({uploads:currentUploads},function(){_this3.forceUpdate();});}catch(e){return console.log(e);}};setLoaded=function setLoaded(moreLoaded){try{var currentUploads=_this3.state.uploads;currentUploads[uuid].loaded+=moreLoaded;window.customVariables.uploads[uuid].loaded+=moreLoaded;return _this3.setState({uploads:currentUploads});}catch(e){return console.log(e);}};addToState();_this3.spawnToast(language.get(_this3.state.lang,\"fileUploadStarted\",true,[\"__NAME__\"],[file.name]));_context5.next=37;return window.customVariables.uploadSemaphore.acquire();case 37:uploadInterval=setInterval(function(){if(offset<file.size){if(firstDone){doFirst=true;}if(doFirst){if(!firstDone){doFirst=false;}offset+=chunkSizeToUse;currentIndex+=1;var thisIndex=currentIndex;var chunk=file.slice(offset,offset+chunkSizeToUse);var fileReader=new FileReader();fileReader.onload=/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){var arrayBuffer;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:arrayBuffer=fileReader.result;workers.encryptData(uuid,thisIndex,key,arrayBuffer,function(encrypted){var blob=encrypted;arrayBuffer=null;var queryParams=new URLSearchParams({apiKey:_this3.state.userAPIKey,uuid:uuid,name:nameEnc,nameHashed:nameH,size:sizeEnc,chunks:fileChunks,mime:mimeEnc,index:thisIndex,rm:rm,expire:expire,uploadKey:uploadKey,metaData:metaData,parent:parent}).toString();_this3.uploadChunk(uuid,file,queryParams,blob,0,1000000,function(err,res,parsedQueryParams){if(err){console.log(err);window.customVariables.uploadSemaphore.release();removeFromState();if(err==\"stopped\"){if(typeof window.customVariables.stoppedUploadsDone[file.uuid]==\"undefined\"){window.customVariables.stoppedUploadsDone[file.uuid]=true;return _this3.spawnToast(language.get(_this3.state.lang,\"uploadStopped\",true,[\"__NAME__\"],[file.name]));}else{return false;}}else{return _this3.spawnToast(language.get(_this3.state.lang,\"fileUploadFailed\",true,[\"__NAME__\"],[file.name]));}}chunksUploaded+=1;if(typeof window.customVariables.uploads[uuid]!==\"undefined\"){setLoaded(blob.length);try{var progress=(window.customVariables.uploads[uuid].loaded/window.customVariables.uploads[uuid].size*100).toFixed(2);if(progress>=100){progress=100;}setProgress(progress);}catch(e){console.log(e);}}blob=null;firstDone=true;if(chunksUploaded-1>=fileChunks){clearInterval(uploadInterval);if(!markedAsDone){markedAsDone=true;_this3.markUploadAsDone(uuid,uploadKey,0,1000000,function(err){if(err){console.log(err);window.customVariables.uploadSemaphore.release();removeFromState();return _this3.spawnToast(language.get(_this3.state.lang,\"fileUploadFailed\",true,[\"__NAME__\"],[file.name]));}utils.checkIfItemParentIsBeingShared(parent,\"file\",{uuid:uuid,name:name,size:parseInt(size),mime:mime,key:key},function(){if(utils.currentParentFolder()==parent){clearInterval(window.customVariables.reloadContentAfterUploadTimeout);window.customVariables.reloadContentAfterUploadTimeout=setTimeout(function(){if(utils.currentParentFolder()==parent){_this3.updateItemList(false);}},1000);}_this3.spawnToast(language.get(_this3.state.lang,\"fileUploadDone\",true,[\"__NAME__\"],[file.name]));window.customVariables.uploadSemaphore.release();return removeFromState();});});}}});});case 2:case\"end\":return _context4.stop();}}},_callee4);}));fileReader.onerror=function(err){window.customVariables.uploadSemaphore.release();console.log(err);removeFromState();return _this3.spawnToast(language.get(_this3.state.lang,\"fileUploadCouldNotReadFile\",true,[\"__NAME__\"],[file.name]));};fileReader.readAsArrayBuffer(chunk);}}},100);case 38:case\"end\":return _context5.stop();}}},_callee5);}));return function(_x17,_x18,_x19){return _ref.apply(this,arguments);};}());case 14:case\"end\":return _context6.stop();}}},_callee6,this);}));return _queueFileUpload.apply(this,arguments);}","map":{"version":3,"sources":["/Users/jan/Documents/filen/app/src/components/upload.js"],"names":["language","workers","Capacitor","Plugins","utils","require","fileExists","name","parent","callback","apiRequest","apiKey","state","userAPIKey","nameHashed","hashFn","toLowerCase","res","status","message","data","exists","uuid","markUploadAsDone","uploadKey","tries","maxTries","Error","console","log","setTimeout","uploadChunk","file","queryParams","window","customVariables","uploadChunkSemaphore","acquire","stoppedUploads","fetch","getUploadServer","method","cache","body","then","response","json","obj","release","parseQuery","catch","err","queueFileUpload","isNative","settings","onlyWifi","Network","getStatus","networkStatus","connectionType","spawnToast","get","lang","size","currentParentFolder","indexOf","fileNameEx","split","lowerCaseFileEnding","length","pop","fileNameWithLowerCaseEnding","join","Object","defineProperty","writable","value","removeIllegalCharsFromString","nameRegex","checkIfNameIsBanned","fileNameValidationRegex","existsUUID","mime","type","uuidv4","key","generateRandomString","rm","expire","chunkSizeToUse","dummyOffset","fileChunks","offset","currentIndex","nameEnc","cryptoJSEncrypt","nameH","mimeEnc","sizeEnc","toString","metaData","JSON","stringify","userMasterKeys","firstDone","doFirst","markedAsDone","chunksUploaded","undefined","stoppedUploadsDone","addToState","currentUploads","uploads","chunks","loaded","progress","setState","uploadsCount","removeFromState","setProgress","forceUpdate","e","setLoaded","moreLoaded","uploadSemaphore","uploadInterval","setInterval","thisIndex","chunk","slice","fileReader","FileReader","onload","arrayBuffer","result","encryptData","encrypted","blob","URLSearchParams","index","parsedQueryParams","toFixed","clearInterval","checkIfItemParentIsBeingShared","parseInt","reloadContentAfterUploadTimeout","updateItemList","onerror","readAsArrayBuffer"],"mappings":"uSAAA,MAAO,GAAKA,CAAAA,QAAZ,KAA0B,mBAA1B,CACA,MAAO,GAAKC,CAAAA,OAAZ,KAAyB,kBAAzB,CACA,OAASC,SAAT,CAAoBC,OAApB,KAAmC,iBAAnC,CAEA,GAAMC,CAAAA,KAAK,CAAGC,OAAO,CAAC,gBAAD,CAArB,CAEA,eAAsBC,CAAAA,UAAtB,uD,2FAAO,iBAA0BC,IAA1B,CAAgCC,MAAhC,CAAwCC,QAAxC,0HACN,GAAGD,MAAM,EAAI,IAAb,CAAkB,CACjBA,MAAM,CAAG,SAAT,CACA,CAHK,sCAMWJ,CAAAA,KAAK,CAACM,UAAN,CAAiB,MAAjB,CAAyB,iBAAzB,CAA4C,CAC3DC,MAAM,CAAE,KAAKC,KAAL,CAAWC,UADwC,CAE3DL,MAAM,CAANA,MAF2D,CAG3DM,UAAU,CAAEV,KAAK,CAACW,MAAN,CAAaR,IAAI,CAACS,WAAL,EAAb,CAH+C,CAA5C,CANX,QAMDC,GANC,8HAaER,QAAQ,aAbV,aAgBFQ,GAAG,CAACC,MAhBF,0DAiBET,QAAQ,CAACQ,GAAG,CAACE,OAAL,CAjBV,0CAoBCV,QAAQ,CAAC,IAAD,CAAOQ,GAAG,CAACG,IAAJ,CAASC,MAAhB,CAAwBJ,GAAG,CAACG,IAAJ,CAASE,IAAjC,CApBT,sE,6CAuBP,eAAsBC,CAAAA,gBAAtB,sE,uGAAO,kBAAgCD,IAAhC,CAAsCE,SAAtC,CAAiDC,KAAjD,CAAwDC,QAAxD,CAAkEjB,QAAlE,kJACHgB,KAAK,EAAIC,QADN,4DAEEjB,QAAQ,CAAC,GAAIkB,CAAAA,KAAJ,CAAU,mDAAV,CAAD,CAFV,iDAMiBvB,CAAAA,KAAK,CAACM,UAAN,CAAiB,MAAjB,CAAyB,iBAAzB,CAA4C,CACjEY,IAAI,CAAJA,IADiE,CAEjEE,SAAS,CAATA,SAFiE,CAA5C,CANjB,QAMKP,GANL,mGAYLW,OAAO,CAACC,GAAR,eAZK,iCAcEC,UAAU,CAAC,UAAM,CACvB,KAAI,CAACP,gBAAL,CAAsBD,IAAtB,CAA4BE,SAA5B,CAAwCC,KAAK,CAAG,CAAhD,CAAoDC,QAApD,CAA8DjB,QAA9D,EACA,CAFgB,CAEd,IAFc,CAdZ,aAmBCQ,GAAG,CAACC,MAnBL,2BAoBCU,OAAO,CAACC,GAAR,CAAYZ,GAAG,CAACE,OAAhB,EApBD,iCAsBQV,QAAQ,CAACQ,GAAG,CAACE,OAAL,CAtBhB,2CAyBCV,QAAQ,CAAC,IAAD,CAzBT,wE,mDA4BP,eAAsBsB,CAAAA,WAAtB,+E,6FAAO,kBAA2BT,IAA3B,CAAiCU,IAAjC,CAAuCC,WAAvC,CAAoDb,IAApD,CAA0DK,KAA1D,CAAiEC,QAAjE,CAA2EjB,QAA3E,6JACAyB,CAAAA,MAAM,CAACC,eAAP,CAAuBC,oBAAvB,CAA4CC,OAA5C,EADA,aAGH,MAAOH,CAAAA,MAAM,CAACC,eAAP,CAAuBG,cAAvB,CAAsChB,IAAtC,CAAP,GAAuD,WAHpD,4DAIQb,QAAQ,CAAC,SAAD,CAJhB,SAON8B,KAAK,CAACnC,KAAK,CAACoC,eAAN,GAA0B,aAA1B,CAA0CP,WAA3C,CAAwD,CAC5DQ,MAAM,CAAE,MADoD,CAE5DC,KAAK,CAAE,UAFqD,CAG5DC,IAAI,CAAEvB,IAHsD,CAAxD,CAAL,CAIGwB,IAJH,CAIQ,SAACC,QAAD,CAAc,CACrBA,QAAQ,CAACC,IAAT,GAAgBF,IAAhB,CAAqB,SAACG,GAAD,CAAS,CAC7B,GAAI9B,CAAAA,GAAG,CAAG8B,GAAV,CAEAb,MAAM,CAACC,eAAP,CAAuBC,oBAAvB,CAA4CY,OAA5C,GAEA,GAAG,MAAOd,CAAAA,MAAM,CAACC,eAAP,CAAuBG,cAAvB,CAAsChB,IAAtC,CAAP,GAAuD,WAA1D,CAAsE,CACrE,MAAOb,CAAAA,QAAQ,CAAC,SAAD,CAAf,CACA,CAED,GAAG,CAACQ,GAAJ,CAAQ,CACP,MAAOa,CAAAA,UAAU,CAAC,UAAM,CACvB,MAAI,CAACC,WAAL,CAAiBT,IAAjB,CAAuBU,IAAvB,CAA6BC,WAA7B,CAA0Cb,IAA1C,CAAiDK,KAAK,CAAG,CAAzD,CAA6DC,QAA7D,CAAuEjB,QAAvE,EACA,CAFgB,CAEd,IAFc,CAAjB,CAGA,CAJD,IAKI,CACH,GAAG,MAAOQ,CAAAA,GAAP,GAAe,QAAlB,CAA2B,CAC1B,MAAOa,CAAAA,UAAU,CAAC,UAAM,CACvB,MAAI,CAACC,WAAL,CAAiBT,IAAjB,CAAuBU,IAAvB,CAA6BC,WAA7B,CAA0Cb,IAA1C,CAAiDK,KAAK,CAAG,CAAzD,CAA6DC,QAA7D,CAAuEjB,QAAvE,EACA,CAFgB,CAEd,IAFc,CAAjB,CAGA,CAJD,IAKI,CACH,GAAG,CAACQ,GAAG,CAACC,MAAR,CAAe,CACd,MAAOT,CAAAA,QAAQ,CAACQ,GAAG,CAACE,OAAL,CAAf,CACA,CAFD,IAGI,CACH,MAAOV,CAAAA,QAAQ,CAAC,IAAD,CAAOQ,GAAP,CAAYb,KAAK,CAAC6C,UAAN,CAAiBhB,WAAjB,CAAZ,CAAf,CACA,CACD,CACD,CACD,CA7BD,EA6BGiB,KA7BH,CA6BS,SAACC,GAAD,CAAS,CACjBvB,OAAO,CAACC,GAAR,CAAYsB,GAAZ,EAEAjB,MAAM,CAACC,eAAP,CAAuBC,oBAAvB,CAA4CY,OAA5C,GAEA,MAAOlB,CAAAA,UAAU,CAAC,UAAM,CACvB,MAAI,CAACC,WAAL,CAAiBT,IAAjB,CAAuBU,IAAvB,CAA6BC,WAA7B,CAA0Cb,IAA1C,CAAiDK,KAAK,CAAG,CAAzD,CAA6DC,QAA7D,CAAuEjB,QAAvE,EACA,CAFgB,CAEd,IAFc,CAAjB,CAGA,CArCD,EAsCA,CA3CD,EA2CGyC,KA3CH,CA2CS,SAACC,GAAD,CAAS,CACjBvB,OAAO,CAACC,GAAR,CAAYsB,GAAZ,EAEAjB,MAAM,CAACC,eAAP,CAAuBC,oBAAvB,CAA4CY,OAA5C,GAEA,MAAOlB,CAAAA,UAAU,CAAC,UAAM,CACvB,MAAI,CAACC,WAAL,CAAiBT,IAAjB,CAAuBU,IAAvB,CAA6BC,WAA7B,CAA0Cb,IAA1C,CAAiDK,KAAK,CAAG,CAAzD,CAA6DC,QAA7D,CAAuEjB,QAAvE,EACA,CAFgB,CAEd,IAFc,CAAjB,CAGA,CAnDD,EAPM,wD,8CA6DP,eAAsB2C,CAAAA,eAAtB,sD,qGAAO,kBAA+BpB,IAA/B,8NACH9B,SAAS,CAACmD,QADP,8BAEI,KAAKzC,KAAL,CAAW0C,QAAX,CAAoBC,QAFxB,iDAG+BpD,CAAAA,OAAO,CAACqD,OAAR,CAAgBC,SAAhB,EAH/B,QAGSC,aAHT,qBAKQA,aAAa,CAACC,cAAd,GAAiC,MALzC,4DAMgB,KAAKC,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,KAAKjD,KAAL,CAAWkD,IAAxB,CAA8B,eAA9B,CAAhB,CANhB,cAWA9B,IAAI,CAAC+B,IAAL,EAAa,CAXb,4DAYQ,KAAKH,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,KAAKjD,KAAL,CAAWkD,IAAxB,CAA8B,uBAA9B,CAAuD,IAAvD,CAA6D,CAAC,UAAD,CAA7D,CAA2E,CAAC9B,IAAI,CAACzB,IAAN,CAA3E,CAAhB,CAZR,SAeFC,MAfE,CAeOJ,KAAK,CAAC4D,mBAAN,EAfP,CAiBN,GAAGhC,IAAI,CAACzB,IAAL,CAAU0D,OAAV,CAAkB,GAAlB,IAA2B,CAAC,CAA/B,CAAiC,CAC5BC,UAD4B,CACflC,IAAI,CAACzB,IAAL,CAAU4D,KAAV,CAAgB,GAAhB,CADe,CAE5BC,mBAF4B,CAENF,UAAU,CAACA,UAAU,CAACG,MAAX,CAAoB,CAArB,CAAV,CAAkCrD,WAAlC,EAFM,CAIhCkD,UAAU,CAACI,GAAX,GAEIC,2BAN4B,CAMEL,UAAU,CAACM,IAAX,CAAgB,GAAhB,EAAuB,GAAvB,CAA6BJ,mBAN/B,CAQhCK,MAAM,CAACC,cAAP,CAAsB1C,IAAtB,CAA4B,MAA5B,CAAoC,CAAE2C,QAAQ,CAAE,IAAZ,CAAkBC,KAAK,CAAExE,KAAK,CAACyE,4BAAN,CAAmCN,2BAAnC,CAAzB,CAApC,EACA,CA1BK,KA4BHnE,KAAK,CAAC0E,SAAN,CAAgB9C,IAAI,CAACzB,IAArB,GAA8BH,KAAK,CAAC2E,mBAAN,CAA0B/C,IAAI,CAACzB,IAA/B,CAA9B,EAAsEH,KAAK,CAAC4E,uBAAN,CAA8BhD,IAAI,CAACzB,IAAnC,CA5BnE,6DA6BE,KAAKqD,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,KAAKjD,KAAL,CAAWkD,IAAxB,CAA8B,2BAA9B,CAA2D,IAA3D,CAAiE,CAAC,UAAD,CAAjE,CAA+E,CAAC9B,IAAI,CAACzB,IAAN,CAA/E,CAAhB,CA7BF,UAgCN,KAAKD,UAAL,CAAgB0B,IAAI,CAACzB,IAArB,CAA2BC,MAA3B,0FAAmC,kBAAO2C,GAAP,CAAY9B,MAAZ,CAAoB4D,UAApB,yXAC/B9B,GAD+B,2DAE1B,MAAI,CAACS,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,MAAI,CAACjD,KAAL,CAAWkD,IAAxB,CAA8B,iBAA9B,CAAhB,CAF0B,aAK/BzC,MAL+B,2DAM1B,MAAI,CAACuC,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,MAAI,CAACjD,KAAL,CAAWkD,IAAxB,CAA8B,6BAA9B,CAA6D,IAA7D,CAAmE,CAAC,UAAD,CAAnE,CAAiF,CAAC9B,IAAI,CAACzB,IAAN,CAAjF,CAAhB,CAN0B,SAS9BA,IAT8B,CASvByB,IAAI,CAACzB,IATkB,CAU9B2E,IAV8B,CAUvBlD,IAAI,CAACmD,IAVkB,CAW9BpB,IAX8B,CAWvB/B,IAAI,CAAC+B,IAXkB,CAY9BzC,IAZ8B,CAYvBlB,KAAK,CAACgF,MAAN,EAZuB,CAa9BC,GAb8B,CAaxBjF,KAAK,CAACkF,oBAAN,CAA2B,EAA3B,CAbwB,CAc9BC,EAd8B,CAczBnF,KAAK,CAACkF,oBAAN,CAA2B,EAA3B,CAdyB,CAe9B9D,SAf8B,CAelBpB,KAAK,CAACkF,oBAAN,CAA2B,EAA3B,CAfkB,CAgB9BE,MAhB8B,CAgBrB,OAhBqB,CAiB9BC,cAjB8B,CAiBX,KAAO,IAAR,CAAgB,CAjBJ,CAkB9BC,WAlB8B,CAkBhB,CAlBgB,CAmB9BC,UAnB8B,CAmBjB,CAnBiB,CAqBlC,MAAMD,WAAW,CAAG1D,IAAI,CAAC+B,IAAzB,CAA8B,CAC7B4B,UAAU,GACVD,WAAW,EAAID,cAAf,CACA,CAEGG,MA1B8B,CA0BpB,EAAIH,cA1BgB,CA2B9BI,YA3B8B,CA2Bf,CAAC,CA3Bc,CA6B9BC,OA7B8B,CA6BpB1F,KAAK,CAAC2F,eAAN,CAAsBxF,IAAtB,CAA4B8E,GAA5B,CA7BoB,CA8B9BW,KA9B8B,CA8BtB5F,KAAK,CAACW,MAAN,CAAaR,IAAI,CAACS,WAAL,EAAb,CA9BsB,CA+B9BiF,OA/B8B,CA+BpB7F,KAAK,CAAC2F,eAAN,CAAsBb,IAAtB,CAA4BG,GAA5B,CA/BoB,CAgC9Ba,OAhC8B,CAgCpB9F,KAAK,CAAC2F,eAAN,CAAsBhC,IAAI,CAACoC,QAAL,EAAtB,CAAuCd,GAAvC,CAhCoB,CAkC9Be,QAlC8B,CAkCnBhG,KAAK,CAAC2F,eAAN,CAAsBM,IAAI,CAACC,SAAL,CAAe,CACnD/F,IAAI,CAAJA,IADmD,CAEnDwD,IAAI,CAAJA,IAFmD,CAGnDmB,IAAI,CAAJA,IAHmD,CAInDG,GAAG,CAAHA,GAJmD,CAAf,CAAtB,CAKX,MAAI,CAACzE,KAAL,CAAW2F,cAAX,CAA0B,MAAI,CAAC3F,KAAL,CAAW2F,cAAX,CAA0BlC,MAA1B,CAAmC,CAA7D,CALW,CAlCmB,CAyC9BmC,SAzC8B,CAyClB,KAzCkB,CA0C9BC,OA1C8B,CA0CpB,IA1CoB,CA2C9BC,YA3C8B,CA2Cf,KA3Ce,CA4C9BC,cA5C8B,CA4Cb,CA5Ca,CA8ClCzE,MAAM,CAACC,eAAP,CAAuBG,cAAvB,CAAsChB,IAAtC,EAA8CsF,SAA9C,CACG1E,MAAM,CAACC,eAAP,CAAuB0E,kBAAvB,CAA0CvF,IAA1C,EAAkDsF,SAAlD,CAEGE,UAjD4B,CAiDf,QAAbA,CAAAA,UAAa,EAAM,CACxB,GAAIC,CAAAA,cAAc,CAAG,MAAI,CAACnG,KAAL,CAAWoG,OAAhC,CAEAD,cAAc,CAACzF,IAAD,CAAd,CAAuB,CACtBA,IAAI,CAAJA,IADsB,CAEtByC,IAAI,CAAJA,IAFsB,CAGtBkD,MAAM,CAAEtB,UAHc,CAItBuB,MAAM,CAAE,CAJc,CAKtBC,QAAQ,CAAE,CALY,CAMtB5G,IAAI,CAAEA,IANgB,CAAvB,CASA2B,MAAM,CAACC,eAAP,CAAuB6E,OAAvB,CAA+B1F,IAA/B,EAAuC,CACtCA,IAAI,CAAJA,IADsC,CAEtCyC,IAAI,CAAJA,IAFsC,CAGtCkD,MAAM,CAAEtB,UAH8B,CAItCuB,MAAM,CAAE,CAJ8B,CAKtCC,QAAQ,CAAE,CAL4B,CAMtC5G,IAAI,CAAEA,IANgC,CAAvC,CASA,MAAO,CAAA,MAAI,CAAC6G,QAAL,CAAc,CACpBJ,OAAO,CAAED,cADW,CAEpBM,YAAY,CAAG,MAAI,CAACzG,KAAL,CAAWyG,YAAX,CAA0B,CAFrB,CAAd,CAAP,CAIA,CA1EiC,CA4E5BC,eA5E4B,CA4EV,QAAlBA,CAAAA,eAAkB,EAAM,CAC7B,GAAIP,CAAAA,cAAc,CAAG,MAAI,CAACnG,KAAL,CAAWoG,OAAhC,CAEA,MAAOD,CAAAA,cAAc,CAACzF,IAAD,CAArB,CACA,MAAOY,CAAAA,MAAM,CAACC,eAAP,CAAuB6E,OAAvB,CAA+B1F,IAA/B,CAAP,CAEA,MAAO,CAAA,MAAI,CAAC8F,QAAL,CAAc,CACpBJ,OAAO,CAAED,cADW,CAEpBM,YAAY,CAAG,MAAI,CAACzG,KAAL,CAAWyG,YAAX,CAA0B,CAFrB,CAAd,CAAP,CAIA,CAtFiC,CAwF5BE,WAxF4B,CAwFd,QAAdA,CAAAA,WAAc,CAACJ,QAAD,CAAc,CACjC,GAAG,CACF,GAAIJ,CAAAA,cAAc,CAAG,MAAI,CAACnG,KAAL,CAAWoG,OAAhC,CAEAD,cAAc,CAACzF,IAAD,CAAd,CAAqB6F,QAArB,CAAgCA,QAAhC,CACAjF,MAAM,CAACC,eAAP,CAAuB6E,OAAvB,CAA+B1F,IAA/B,EAAqC6F,QAArC,CAAgDA,QAAhD,CAEA,MAAO,CAAA,MAAI,CAACC,QAAL,CAAc,CACpBJ,OAAO,CAAED,cADW,CAAd,CAEJ,UAAM,CACR,MAAI,CAACS,WAAL,GACA,CAJM,CAAP,CAKA,CACD,MAAMC,CAAN,CAAQ,CACP,MAAO7F,CAAAA,OAAO,CAACC,GAAR,CAAY4F,CAAZ,CAAP,CACA,CACD,CAxGiC,CA0G5BC,SA1G4B,CA0GhB,QAAZA,CAAAA,SAAY,CAACC,UAAD,CAAgB,CACjC,GAAG,CACF,GAAIZ,CAAAA,cAAc,CAAG,MAAI,CAACnG,KAAL,CAAWoG,OAAhC,CAEAD,cAAc,CAACzF,IAAD,CAAd,CAAqB4F,MAArB,EAA+BS,UAA/B,CACAzF,MAAM,CAACC,eAAP,CAAuB6E,OAAvB,CAA+B1F,IAA/B,EAAqC4F,MAArC,EAA+CS,UAA/C,CAEA,MAAO,CAAA,MAAI,CAACP,QAAL,CAAc,CACpBJ,OAAO,CAAED,cADW,CAAd,CAAP,CAGA,CACD,MAAMU,CAAN,CAAQ,CACP,MAAO7F,CAAAA,OAAO,CAACC,GAAR,CAAY4F,CAAZ,CAAP,CACA,CACD,CAxHiC,CA0HlCX,UAAU,GAEV,MAAI,CAAClD,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,MAAI,CAACjD,KAAL,CAAWkD,IAAxB,CAA8B,mBAA9B,CAAmD,IAAnD,CAAyD,CAAC,UAAD,CAAzD,CAAuE,CAAC9B,IAAI,CAACzB,IAAN,CAAvE,CAAhB,EA5HkC,wBA8H5B2B,CAAAA,MAAM,CAACC,eAAP,CAAuByF,eAAvB,CAAuCvF,OAAvC,EA9H4B,SAgI9BwF,cAhI8B,CAgIbC,WAAW,CAAC,UAAM,CACtC,GAAGlC,MAAM,CAAG5D,IAAI,CAAC+B,IAAjB,CAAsB,CACrB,GAAGyC,SAAH,CAAa,CACZC,OAAO,CAAG,IAAV,CACA,CAED,GAAGA,OAAH,CAAW,CACV,GAAG,CAACD,SAAJ,CAAc,CACbC,OAAO,CAAG,KAAV,CACA,CAEDb,MAAM,EAAIH,cAAV,CACAI,YAAY,EAAI,CAAhB,CAEA,GAAIkC,CAAAA,SAAS,CAAGlC,YAAhB,CACA,GAAImC,CAAAA,KAAK,CAAGhG,IAAI,CAACiG,KAAL,CAAWrC,MAAX,CAAoBA,MAAM,CAAGH,cAA7B,CAAZ,CAEA,GAAIyC,CAAAA,UAAU,CAAG,GAAIC,CAAAA,UAAJ,EAAjB,CAEAD,UAAU,CAACE,MAAX,sEAAoB,wJACfC,WADe,CACDH,UAAU,CAACI,MADV,CAGnBrI,OAAO,CAACsI,WAAR,CAAoBjH,IAApB,CAA0ByG,SAA1B,CAAqC1C,GAArC,CAA0CgD,WAA1C,CAAuD,SAACG,SAAD,CAAe,CACrE,GAAIC,CAAAA,IAAI,CAAGD,SAAX,CAEAH,WAAW,CAAG,IAAd,CAEA,GAAIpG,CAAAA,WAAW,CAAG,GAAIyG,CAAAA,eAAJ,CAAoB,CACrC/H,MAAM,CAAE,MAAI,CAACC,KAAL,CAAWC,UADkB,CAErCS,IAAI,CAAEA,IAF+B,CAGrCf,IAAI,CAAEuF,OAH+B,CAIrChF,UAAU,CAAEkF,KAJyB,CAKrCjC,IAAI,CAAEmC,OAL+B,CAMrCe,MAAM,CAAEtB,UAN6B,CAOrCT,IAAI,CAAEe,OAP+B,CAQrC0C,KAAK,CAAEZ,SAR8B,CASrCxC,EAAE,CAAEA,EATiC,CAUrCC,MAAM,CAAEA,MAV6B,CAWrChE,SAAS,CAAEA,SAX0B,CAYrC4E,QAAQ,CAAEA,QAZ2B,CAarC5F,MAAM,CAAEA,MAb6B,CAApB,EAcf2F,QAde,EAAlB,CAgBA,MAAI,CAACpE,WAAL,CAAiBT,IAAjB,CAAuBU,IAAvB,CAA6BC,WAA7B,CAA0CwG,IAA1C,CAAgD,CAAhD,CAAmD,OAAnD,CAA4D,SAACtF,GAAD,CAAMlC,GAAN,CAAW2H,iBAAX,CAAiC,CAC5F,GAAGzF,GAAH,CAAO,CACNvB,OAAO,CAACC,GAAR,CAAYsB,GAAZ,EAEAjB,MAAM,CAACC,eAAP,CAAuByF,eAAvB,CAAuC5E,OAAvC,GAEAsE,eAAe,GAEf,GAAGnE,GAAG,EAAI,SAAV,CAAoB,CACnB,GAAG,MAAOjB,CAAAA,MAAM,CAACC,eAAP,CAAuB0E,kBAAvB,CAA0C7E,IAAI,CAACV,IAA/C,CAAP,EAA+D,WAAlE,CAA8E,CAC7EY,MAAM,CAACC,eAAP,CAAuB0E,kBAAvB,CAA0C7E,IAAI,CAACV,IAA/C,EAAuD,IAAvD,CAEA,MAAO,CAAA,MAAI,CAACsC,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,MAAI,CAACjD,KAAL,CAAWkD,IAAxB,CAA8B,eAA9B,CAA+C,IAA/C,CAAqD,CAAC,UAAD,CAArD,CAAmE,CAAC9B,IAAI,CAACzB,IAAN,CAAnE,CAAhB,CAAP,CACA,CAJD,IAKI,CACH,MAAO,MAAP,CACA,CACD,CATD,IAUI,CACH,MAAO,CAAA,MAAI,CAACqD,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,MAAI,CAACjD,KAAL,CAAWkD,IAAxB,CAA8B,kBAA9B,CAAkD,IAAlD,CAAwD,CAAC,UAAD,CAAxD,CAAsE,CAAC9B,IAAI,CAACzB,IAAN,CAAtE,CAAhB,CAAP,CACA,CACD,CAEDoG,cAAc,EAAI,CAAlB,CAEA,GAAG,MAAOzE,CAAAA,MAAM,CAACC,eAAP,CAAuB6E,OAAvB,CAA+B1F,IAA/B,CAAP,GAAgD,WAAnD,CAA+D,CAC9DoG,SAAS,CAACe,IAAI,CAACpE,MAAN,CAAT,CAEA,GAAG,CACF,GAAI8C,CAAAA,QAAQ,CAAG,CAAEjF,MAAM,CAACC,eAAP,CAAuB6E,OAAvB,CAA+B1F,IAA/B,EAAqC4F,MAArC,CAA8ChF,MAAM,CAACC,eAAP,CAAuB6E,OAAvB,CAA+B1F,IAA/B,EAAqCyC,IAApF,CAA4F,GAA7F,EAAkG8E,OAAlG,CAA0G,CAA1G,CAAf,CAEA,GAAG1B,QAAQ,EAAI,GAAf,CAAmB,CAClBA,QAAQ,CAAG,GAAX,CACA,CAEDI,WAAW,CAACJ,QAAD,CAAX,CACA,CACD,MAAMM,CAAN,CAAQ,CACP7F,OAAO,CAACC,GAAR,CAAY4F,CAAZ,EACA,CACD,CAEDgB,IAAI,CAAG,IAAP,CACAjC,SAAS,CAAG,IAAZ,CAEA,GAAIG,cAAc,CAAG,CAAlB,EAAwBhB,UAA3B,CAAsC,CACrCmD,aAAa,CAACjB,cAAD,CAAb,CAEA,GAAG,CAACnB,YAAJ,CAAiB,CAChBA,YAAY,CAAG,IAAf,CAEA,MAAI,CAACnF,gBAAL,CAAsBD,IAAtB,CAA4BE,SAA5B,CAAuC,CAAvC,CAA0C,OAA1C,CAAmD,SAAC2B,GAAD,CAAS,CAC3D,GAAGA,GAAH,CAAO,CACNvB,OAAO,CAACC,GAAR,CAAYsB,GAAZ,EAEAjB,MAAM,CAACC,eAAP,CAAuByF,eAAvB,CAAuC5E,OAAvC,GAEAsE,eAAe,GAEf,MAAO,CAAA,MAAI,CAAC1D,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,MAAI,CAACjD,KAAL,CAAWkD,IAAxB,CAA8B,kBAA9B,CAAkD,IAAlD,CAAwD,CAAC,UAAD,CAAxD,CAAsE,CAAC9B,IAAI,CAACzB,IAAN,CAAtE,CAAhB,CAAP,CACA,CAEDH,KAAK,CAAC2I,8BAAN,CAAqCvI,MAArC,CAA6C,MAA7C,CAAqD,CACpDc,IAAI,CAAJA,IADoD,CAEpDf,IAAI,CAAJA,IAFoD,CAGpDwD,IAAI,CAAEiF,QAAQ,CAACjF,IAAD,CAHsC,CAIpDmB,IAAI,CAAJA,IAJoD,CAKpDG,GAAG,CAAHA,GALoD,CAArD,CAMG,UAAM,CACR,GAAGjF,KAAK,CAAC4D,mBAAN,IAA+BxD,MAAlC,CAAyC,CACxCsI,aAAa,CAAC5G,MAAM,CAACC,eAAP,CAAuB8G,+BAAxB,CAAb,CAEA/G,MAAM,CAACC,eAAP,CAAuB8G,+BAAvB,CAAyDnH,UAAU,CAAC,UAAM,CACzE,GAAG1B,KAAK,CAAC4D,mBAAN,IAA+BxD,MAAlC,CAAyC,CACxC,MAAI,CAAC0I,cAAL,CAAoB,KAApB,EACA,CACD,CAJkE,CAIhE,IAJgE,CAAnE,CAKA,CAED,MAAI,CAACtF,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,MAAI,CAACjD,KAAL,CAAWkD,IAAxB,CAA8B,gBAA9B,CAAgD,IAAhD,CAAsD,CAAC,UAAD,CAAtD,CAAoE,CAAC9B,IAAI,CAACzB,IAAN,CAApE,CAAhB,EAEA2B,MAAM,CAACC,eAAP,CAAuByF,eAAvB,CAAuC5E,OAAvC,GAEA,MAAOsE,CAAAA,eAAe,EAAtB,CACA,CAtBD,EAuBA,CAlCD,EAmCA,CACD,CACD,CAxFD,EAyFA,CA9GD,EAHmB,wDAApB,GAoHAY,UAAU,CAACiB,OAAX,CAAqB,SAAChG,GAAD,CAAS,CAC7BjB,MAAM,CAACC,eAAP,CAAuByF,eAAvB,CAAuC5E,OAAvC,GAEApB,OAAO,CAACC,GAAR,CAAYsB,GAAZ,EAEAmE,eAAe,GAEf,MAAO,CAAA,MAAI,CAAC1D,UAAL,CAAgB5D,QAAQ,CAAC6D,GAAT,CAAa,MAAI,CAACjD,KAAL,CAAWkD,IAAxB,CAA8B,4BAA9B,CAA4D,IAA5D,CAAkE,CAAC,UAAD,CAAlE,CAAgF,CAAC9B,IAAI,CAACzB,IAAN,CAAhF,CAAhB,CAAP,CACA,CARD,CAUA2H,UAAU,CAACkB,iBAAX,CAA6BpB,KAA7B,EACA,CACD,CACD,CApJ+B,CAoJ7B,GApJ6B,CAhIE,0DAAnC,4EAhCM,8D","sourcesContent":["import * as language from \"../utils/language\"\r\nimport * as workers from \"../utils/workers\"\r\nimport { Capacitor, Plugins } from \"@capacitor/core\"\r\n\r\nconst utils = require(\"../utils/utils\")\r\n\r\nexport async function fileExists(name, parent, callback){\r\n\tif(parent == null){\r\n\t\tparent = \"default\"\r\n\t}\r\n\r\n\ttry{\r\n\t\tvar res = await utils.apiRequest(\"POST\", \"/v1/file/exists\", {\r\n\t\t\tapiKey: this.state.userAPIKey,\r\n\t\t\tparent,\r\n\t\t\tnameHashed: utils.hashFn(name.toLowerCase())\r\n\t\t})\r\n\t}\r\n\tcatch(e){\r\n\t\treturn callback(e)\r\n\t}\r\n\r\n\tif(!res.status){\r\n\t\treturn callback(res.message)\r\n\t}\r\n\r\n\treturn callback(null, res.data.exists, res.data.uuid)\r\n}\r\n\r\nexport async function markUploadAsDone(uuid, uploadKey, tries, maxTries, callback){\r\n\tif(tries >= maxTries){\r\n\t\treturn callback(new Error(\"mark upload as done max tries reached, returning.\"))\r\n\t}\r\n\r\n\ttry{\r\n        var res = await utils.apiRequest(\"POST\", \"/v1/upload/done\", {\r\n\t\t\tuuid,\r\n\t\t\tuploadKey\r\n        })\r\n    }\r\n    catch(e){\r\n\t\tconsole.log(e)\r\n\t\t\r\n\t\treturn setTimeout(() => {\r\n\t\t\tthis.markUploadAsDone(uuid, uploadKey, (tries + 1), maxTries, callback)\r\n\t\t}, 1000)\r\n    }\r\n\r\n    if(!res.status){\r\n        console.log(res.message)\r\n\r\n        return callback(res.message)\r\n    }\r\n\r\n\treturn callback(null)\r\n}\r\n\r\nexport async function uploadChunk(uuid, file, queryParams, data, tries, maxTries, callback){\r\n\tawait window.customVariables.uploadChunkSemaphore.acquire()\r\n\r\n\tif(typeof window.customVariables.stoppedUploads[uuid] !== \"undefined\"){\r\n        return callback(\"stopped\")\r\n    }\r\n\r\n\tfetch(utils.getUploadServer() + \"/v1/upload?\" + queryParams, {\r\n\t\tmethod: \"POST\",\r\n\t\tcache: \"no-cache\",\r\n\t\tbody: data\r\n\t}).then((response) => {\r\n\t\tresponse.json().then((obj) => {\r\n\t\t\tlet res = obj\r\n\r\n\t\t\twindow.customVariables.uploadChunkSemaphore.release()\r\n\r\n\t\t\tif(typeof window.customVariables.stoppedUploads[uuid] !== \"undefined\"){\r\n\t\t\t\treturn callback(\"stopped\")\r\n\t\t\t}\r\n\r\n\t\t\tif(!res){\r\n\t\t\t\treturn setTimeout(() => {\r\n\t\t\t\t\tthis.uploadChunk(uuid, file, queryParams, data, (tries + 1), maxTries, callback)\r\n\t\t\t\t}, 1000)\r\n\t\t\t}\r\n\t\t\telse{\r\n\t\t\t\tif(typeof res !== \"object\"){\r\n\t\t\t\t\treturn setTimeout(() => {\r\n\t\t\t\t\t\tthis.uploadChunk(uuid, file, queryParams, data, (tries + 1), maxTries, callback)\r\n\t\t\t\t\t}, 1000)\r\n\t\t\t\t}\r\n\t\t\t\telse{\r\n\t\t\t\t\tif(!res.status){\r\n\t\t\t\t\t\treturn callback(res.message)\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse{\r\n\t\t\t\t\t\treturn callback(null, res, utils.parseQuery(queryParams))\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}).catch((err) => {\r\n\t\t\tconsole.log(err)\r\n\r\n\t\t\twindow.customVariables.uploadChunkSemaphore.release()\r\n\r\n\t\t\treturn setTimeout(() => {\r\n\t\t\t\tthis.uploadChunk(uuid, file, queryParams, data, (tries + 1), maxTries, callback)\r\n\t\t\t}, 1000)\r\n\t\t})\r\n\t}).catch((err) => {\r\n\t\tconsole.log(err)\r\n\r\n\t\twindow.customVariables.uploadChunkSemaphore.release()\r\n\r\n\t\treturn setTimeout(() => {\r\n\t\t\tthis.uploadChunk(uuid, file, queryParams, data, (tries + 1), maxTries, callback)\r\n\t\t}, 1000)\r\n\t})\r\n}\r\n\r\nexport async function queueFileUpload(file){\r\n\tif(Capacitor.isNative){\r\n        if(this.state.settings.onlyWifi){\r\n            let networkStatus = await Plugins.Network.getStatus()\r\n\r\n            if(networkStatus.connectionType !== \"wifi\"){\r\n                return this.spawnToast(language.get(this.state.lang, \"onlyWifiError\"))\r\n            }\r\n        }\r\n    }\r\n\r\n    if(file.size <= 0){\r\n        return this.spawnToast(language.get(this.state.lang, \"uploadInvalidFileSize\", true, [\"__NAME__\"], [file.name]))\r\n\t}\r\n\r\n\tlet parent = utils.currentParentFolder()\r\n\t\r\n\tif(file.name.indexOf(\".\") !== -1){\r\n\t\tlet fileNameEx = file.name.split(\".\")\r\n\t\tlet lowerCaseFileEnding = fileNameEx[fileNameEx.length - 1].toLowerCase()\r\n\t\t\r\n\t\tfileNameEx.pop()\r\n\t\t\r\n\t\tlet fileNameWithLowerCaseEnding = fileNameEx.join(\".\") + \".\" + lowerCaseFileEnding\r\n\r\n\t\tObject.defineProperty(file, \"name\", { writable: true, value: utils.removeIllegalCharsFromString(fileNameWithLowerCaseEnding) })\r\n\t}\r\n\r\n\tif(utils.nameRegex(file.name) || utils.checkIfNameIsBanned(file.name) || utils.fileNameValidationRegex(file.name)){\r\n\t\treturn this.spawnToast(language.get(this.state.lang, \"fileUploadInvalidFileName\", true, [\"__NAME__\"], [file.name]))\r\n\t}\r\n\r\n\tthis.fileExists(file.name, parent, async (err, exists, existsUUID) => {\r\n\t\tif(err){\r\n\t\t\treturn this.spawnToast(language.get(this.state.lang, \"apiRequestError\"))\r\n\t\t}\r\n\r\n\t\tif(exists){\r\n\t\t\treturn this.spawnToast(language.get(this.state.lang, \"fileUploadFileAlreadyExists\", true, [\"__NAME__\"], [file.name]))\r\n\t\t}\r\n\r\n\t\tlet name = file.name\r\n\t\tlet mime = file.type\r\n\t\tlet size = file.size\r\n\t\tlet uuid = utils.uuidv4()\r\n\t\tlet key = utils.generateRandomString(32)\r\n\t\tlet rm = utils.generateRandomString(32)\r\n\t\tlet uploadKey = utils.generateRandomString(32)\r\n\t\tlet expire = \"never\"\r\n\t\tlet chunkSizeToUse = ((1024 * 1024) * 1)\r\n\t\tlet dummyOffset = 0\r\n\t\tlet fileChunks = 0\r\n\r\n\t\twhile(dummyOffset < file.size){\r\n\t\t\tfileChunks++\r\n\t\t\tdummyOffset += chunkSizeToUse\r\n\t\t}\r\n\r\n\t\tlet offset = (0 - chunkSizeToUse)\r\n\t\tlet currentIndex = -1\r\n\r\n\t\tlet nameEnc = utils.cryptoJSEncrypt(name, key)\r\n\t\tlet nameH = utils.hashFn(name.toLowerCase())\r\n\t\tlet mimeEnc = utils.cryptoJSEncrypt(mime, key)\r\n\t\tlet sizeEnc = utils.cryptoJSEncrypt(size.toString(), key)\r\n\t\t\r\n\t\tlet metaData = utils.cryptoJSEncrypt(JSON.stringify({\r\n\t\t\tname,\r\n\t\t\tsize,\r\n\t\t\tmime,\r\n\t\t\tkey\r\n\t\t}), this.state.userMasterKeys[this.state.userMasterKeys.length - 1])\r\n\r\n\t\tlet firstDone = false\r\n\t\tlet doFirst = true\r\n\t\tlet markedAsDone = false\r\n\t\tlet chunksUploaded = 0\r\n\r\n\t\twindow.customVariables.stoppedUploads[uuid] = undefined\r\n    \twindow.customVariables.stoppedUploadsDone[uuid] = undefined\r\n\r\n\t\tconst addToState = () => {\r\n\t\t\tlet currentUploads = this.state.uploads\r\n\r\n\t\t\tcurrentUploads[uuid] = {\r\n\t\t\t\tuuid,\r\n\t\t\t\tsize,\r\n\t\t\t\tchunks: fileChunks,\r\n\t\t\t\tloaded: 0,\r\n\t\t\t\tprogress: 0,\r\n\t\t\t\tname: name \r\n\t\t\t}\r\n\r\n\t\t\twindow.customVariables.uploads[uuid] = {\r\n\t\t\t\tuuid,\r\n\t\t\t\tsize,\r\n\t\t\t\tchunks: fileChunks,\r\n\t\t\t\tloaded: 0,\r\n\t\t\t\tprogress: 0,\r\n\t\t\t\tname: name \r\n\t\t\t}\r\n\r\n\t\t\treturn this.setState({\r\n\t\t\t\tuploads: currentUploads,\r\n\t\t\t\tuploadsCount: (this.state.uploadsCount + 1)\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tconst removeFromState = () => {\r\n\t\t\tlet currentUploads = this.state.uploads\r\n\r\n\t\t\tdelete currentUploads[uuid]\r\n\t\t\tdelete window.customVariables.uploads[uuid]\r\n\r\n\t\t\treturn this.setState({\r\n\t\t\t\tuploads: currentUploads,\r\n\t\t\t\tuploadsCount: (this.state.uploadsCount - 1)\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tconst setProgress = (progress) => {\r\n\t\t\ttry{\r\n\t\t\t\tlet currentUploads = this.state.uploads\r\n\r\n\t\t\t\tcurrentUploads[uuid].progress = progress\r\n\t\t\t\twindow.customVariables.uploads[uuid].progress = progress\r\n\r\n\t\t\t\treturn this.setState({\r\n\t\t\t\t\tuploads: currentUploads\r\n\t\t\t\t}, () => {\r\n\t\t\t\t\tthis.forceUpdate()\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tcatch(e){\r\n\t\t\t\treturn console.log(e)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst setLoaded = (moreLoaded) => {\r\n\t\t\ttry{\r\n\t\t\t\tlet currentUploads = this.state.uploads\r\n\r\n\t\t\t\tcurrentUploads[uuid].loaded += moreLoaded\r\n\t\t\t\twindow.customVariables.uploads[uuid].loaded += moreLoaded\r\n\r\n\t\t\t\treturn this.setState({\r\n\t\t\t\t\tuploads: currentUploads\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tcatch(e){\r\n\t\t\t\treturn console.log(e)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\taddToState()\r\n\r\n\t\tthis.spawnToast(language.get(this.state.lang, \"fileUploadStarted\", true, [\"__NAME__\"], [file.name]))\r\n\r\n\t\tawait window.customVariables.uploadSemaphore.acquire()\r\n\r\n\t\tlet uploadInterval = setInterval(() => {\r\n\t\t\tif(offset < file.size){\r\n\t\t\t\tif(firstDone){\r\n\t\t\t\t\tdoFirst = true\r\n\t\t\t\t}\r\n\r\n\t\t\t\tif(doFirst){\r\n\t\t\t\t\tif(!firstDone){\r\n\t\t\t\t\t\tdoFirst = false\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\toffset += chunkSizeToUse\r\n\t\t\t\t\tcurrentIndex += 1\r\n\r\n\t\t\t\t\tlet thisIndex = currentIndex\r\n\t\t\t\t\tlet chunk = file.slice(offset, (offset + chunkSizeToUse))\r\n\r\n\t\t\t\t\tlet fileReader = new FileReader()\r\n\r\n\t\t\t\t\tfileReader.onload = async () => {\r\n\t\t\t\t\t\tlet arrayBuffer = fileReader.result\r\n\r\n\t\t\t\t\t\tworkers.encryptData(uuid, thisIndex, key, arrayBuffer, (encrypted) => {\r\n\t\t\t\t\t\t\tlet blob = encrypted\r\n\r\n\t\t\t\t\t\t\tarrayBuffer = null\r\n\r\n\t\t\t\t\t\t\tlet queryParams = new URLSearchParams({\r\n\t\t\t\t\t\t\t\tapiKey: this.state.userAPIKey,\r\n\t\t\t\t\t\t\t\tuuid: uuid,\r\n\t\t\t\t\t\t\t\tname: nameEnc,\r\n\t\t\t\t\t\t\t\tnameHashed: nameH,\r\n\t\t\t\t\t\t\t\tsize: sizeEnc,\r\n\t\t\t\t\t\t\t\tchunks: fileChunks,\r\n\t\t\t\t\t\t\t\tmime: mimeEnc,\r\n\t\t\t\t\t\t\t\tindex: thisIndex,\r\n\t\t\t\t\t\t\t\trm: rm,\r\n\t\t\t\t\t\t\t\texpire: expire,\r\n\t\t\t\t\t\t\t\tuploadKey: uploadKey,\r\n\t\t\t\t\t\t\t\tmetaData: metaData,\r\n\t\t\t\t\t\t\t\tparent: parent\r\n\t\t\t\t\t\t\t}).toString()\r\n\r\n\t\t\t\t\t\t\tthis.uploadChunk(uuid, file, queryParams, blob, 0, 1000000, (err, res, parsedQueryParams) => {\r\n\t\t\t\t\t\t\t\tif(err){\r\n\t\t\t\t\t\t\t\t\tconsole.log(err)\r\n\r\n\t\t\t\t\t\t\t\t\twindow.customVariables.uploadSemaphore.release()\r\n\r\n\t\t\t\t\t\t\t\t\tremoveFromState()\r\n\r\n\t\t\t\t\t\t\t\t\tif(err == \"stopped\"){\r\n\t\t\t\t\t\t\t\t\t\tif(typeof window.customVariables.stoppedUploadsDone[file.uuid] == \"undefined\"){\r\n\t\t\t\t\t\t\t\t\t\t\twindow.customVariables.stoppedUploadsDone[file.uuid] = true\r\n\r\n\t\t\t\t\t\t\t\t\t\t\treturn this.spawnToast(language.get(this.state.lang, \"uploadStopped\", true, [\"__NAME__\"], [file.name]))\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\t\t\t\t\treturn false\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\telse{\r\n\t\t\t\t\t\t\t\t\t\treturn this.spawnToast(language.get(this.state.lang, \"fileUploadFailed\", true, [\"__NAME__\"], [file.name]))\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\tchunksUploaded += 1\r\n\r\n\t\t\t\t\t\t\t\tif(typeof window.customVariables.uploads[uuid] !== \"undefined\"){\r\n\t\t\t\t\t\t\t\t\tsetLoaded(blob.length)\r\n\r\n\t\t\t\t\t\t\t\t\ttry{\r\n\t\t\t\t\t\t\t\t\t\tlet progress = ((window.customVariables.uploads[uuid].loaded / window.customVariables.uploads[uuid].size) * 100).toFixed(2)\r\n\r\n\t\t\t\t\t\t\t\t\t\tif(progress >= 100){\r\n\t\t\t\t\t\t\t\t\t\t\tprogress = 100\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\tsetProgress(progress)\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\tcatch(e){\r\n\t\t\t\t\t\t\t\t\t\tconsole.log(e)\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\tblob = null\r\n\t\t\t\t\t\t\t\tfirstDone = true\r\n\r\n\t\t\t\t\t\t\t\tif((chunksUploaded - 1) >= fileChunks){\r\n\t\t\t\t\t\t\t\t\tclearInterval(uploadInterval)\r\n\r\n\t\t\t\t\t\t\t\t\tif(!markedAsDone){\r\n\t\t\t\t\t\t\t\t\t\tmarkedAsDone = true\r\n\r\n\t\t\t\t\t\t\t\t\t\tthis.markUploadAsDone(uuid, uploadKey, 0, 1000000, (err) => {\r\n\t\t\t\t\t\t\t\t\t\t\tif(err){\r\n\t\t\t\t\t\t\t\t\t\t\t\tconsole.log(err)\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\twindow.customVariables.uploadSemaphore.release()\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\tremoveFromState()\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\treturn this.spawnToast(language.get(this.state.lang, \"fileUploadFailed\", true, [\"__NAME__\"], [file.name]))\r\n\t\t\t\t\t\t\t\t\t\t\t}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\tutils.checkIfItemParentIsBeingShared(parent, \"file\", {\r\n\t\t\t\t\t\t\t\t\t\t\t\tuuid,\r\n\t\t\t\t\t\t\t\t\t\t\t\tname,\r\n\t\t\t\t\t\t\t\t\t\t\t\tsize: parseInt(size),\r\n\t\t\t\t\t\t\t\t\t\t\t\tmime,\r\n\t\t\t\t\t\t\t\t\t\t\t\tkey\r\n\t\t\t\t\t\t\t\t\t\t\t}, () => {\r\n\t\t\t\t\t\t\t\t\t\t\t\tif(utils.currentParentFolder() == parent){\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tclearInterval(window.customVariables.reloadContentAfterUploadTimeout)\r\n\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\twindow.customVariables.reloadContentAfterUploadTimeout = setTimeout(() => {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tif(utils.currentParentFolder() == parent){\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tthis.updateItemList(false)\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}, 1000)\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\r\n\t\t\t\t\t\t\t\t\t\t\t\tthis.spawnToast(language.get(this.state.lang, \"fileUploadDone\", true, [\"__NAME__\"], [file.name]))\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\twindow.customVariables.uploadSemaphore.release()\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t\treturn removeFromState()\r\n\t\t\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t})\r\n\t\t\t\t\t\t})\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tfileReader.onerror = (err) => {\r\n\t\t\t\t\t\twindow.customVariables.uploadSemaphore.release()\r\n\r\n\t\t\t\t\t\tconsole.log(err)\r\n\r\n\t\t\t\t\t\tremoveFromState()\r\n\r\n\t\t\t\t\t\treturn this.spawnToast(language.get(this.state.lang, \"fileUploadCouldNotReadFile\", true, [\"__NAME__\"], [file.name]))\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tfileReader.readAsArrayBuffer(chunk)\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}, 100)\r\n\t})\r\n}"]},"metadata":{},"sourceType":"module"}