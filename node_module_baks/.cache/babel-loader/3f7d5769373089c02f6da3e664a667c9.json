{"ast":null,"code":"import _regeneratorRuntime from\"/Users/jan/Documents/filen/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/jan/Documents/filen/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import*as language from\"../utils/language\";import{Plugins}from\"@capacitor/core\";var utils=require(\"../utils/utils\");export function updateUserKeys(){return _updateUserKeys.apply(this,arguments);}function _updateUserKeys(){_updateUserKeys=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(){var _this=this;var updateUserKeypair,setUserKeypair,updatePubAndPrivKey,res,newKeys;return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(this.state.isLoggedIn){_context4.next=2;break;}return _context4.abrupt(\"return\",false);case 2:updateUserKeypair=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(pub,priv,callback){var res;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_context.prev=0;_context.next=3;return utils.apiRequest(\"POST\",\"/v1/user/keyPair/update\",{apiKey:_this.state.userAPIKey,publicKey:pub,privateKey:utils.cryptoJSEncrypt(priv,_this.state.userMasterKeys[_this.state.userMasterKeys.length-1])});case 3:res=_context.sent;_context.next=12;break;case 6:_context.prev=6;_context.t0=_context[\"catch\"](0);if(!(typeof callback==\"function\")){_context.next=10;break;}return _context.abrupt(\"return\",callback(_context.t0));case 10:console.log(_context.t0);return _context.abrupt(\"return\",false);case 12:if(res.status){_context.next=19;break;}if(!(typeof callback==\"function\")){_context.next=15;break;}return _context.abrupt(\"return\",callback(res.message));case 15:console.log(res.message);if(!(res.message.toLowerCase().indexOf(\"api key not found\")!==-1)){_context.next=18;break;}return _context.abrupt(\"return\",window.customFunctions.logoutUser());case 18:return _context.abrupt(\"return\",false);case 19:if(!(typeof callback==\"function\")){_context.next=21;break;}return _context.abrupt(\"return\",callback(null,true));case 21:return _context.abrupt(\"return\",true);case 22:case\"end\":return _context.stop();}}},_callee,null,[[0,6]]);}));return function updateUserKeypair(_x,_x2,_x3){return _ref.apply(this,arguments);};}();setUserKeypair=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(pub,priv,callback){var res;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:_context2.prev=0;_context2.next=3;return utils.apiRequest(\"POST\",\"/v1/user/keyPair/set\",{apiKey:_this.state.userAPIKey,publicKey:pub,privateKey:utils.cryptoJSEncrypt(priv,_this.state.userMasterKeys[_this.state.userMasterKeys.length-1])});case 3:res=_context2.sent;_context2.next=12;break;case 6:_context2.prev=6;_context2.t0=_context2[\"catch\"](0);if(!(typeof callback==\"function\")){_context2.next=10;break;}return _context2.abrupt(\"return\",callback(_context2.t0));case 10:console.log(_context2.t0);return _context2.abrupt(\"return\",false);case 12:if(res.status){_context2.next=19;break;}if(!(typeof callback==\"function\")){_context2.next=15;break;}return _context2.abrupt(\"return\",callback(res.message));case 15:console.log(res.message);if(!(res.message.toLowerCase().indexOf(\"api key not found\")!==-1)){_context2.next=18;break;}return _context2.abrupt(\"return\",window.customFunctions.logoutUser());case 18:return _context2.abrupt(\"return\",false);case 19:if(!(typeof callback==\"function\")){_context2.next=21;break;}return _context2.abrupt(\"return\",callback(null,true));case 21:return _context2.abrupt(\"return\",true);case 22:case\"end\":return _context2.stop();}}},_callee2,null,[[0,6]]);}));return function setUserKeypair(_x4,_x5,_x6){return _ref2.apply(this,arguments);};}();updatePubAndPrivKey=/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(){var res,privKey,generatedKeypair,exportedPubKey,b64PubKey,exportedPrivKey,b64PrivKey;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:_context3.prev=0;_context3.next=3;return utils.apiRequest(\"POST\",\"/v1/user/keyPair/info\",{apiKey:_this.state.userAPIKey});case 3:res=_context3.sent;_context3.next=9;break;case 6:_context3.prev=6;_context3.t0=_context3[\"catch\"](0);return _context3.abrupt(\"return\",console.log(_context3.t0));case 9:if(res.status){_context3.next=11;break;}return _context3.abrupt(\"return\",console.log(res.message));case 11:if(!(res.data.publicKey.length>16&&res.data.privateKey.length>16)){_context3.next=27;break;}privKey=\"\";_this.state.userMasterKeys.forEach(function(key){if(privKey.length==0){try{var decrypted=utils.cryptoJSDecrypt(res.data.privateKey,key);if(typeof decrypted==\"string\"){if(decrypted.length>16){privKey=decrypted;}}}catch(e){console.log(e);return;}}});if(!(privKey.length>16)){_context3.next=24;break;}_context3.next=17;return Plugins.Storage.set({key:\"userPublicKey\",value:res.data.publicKey});case 17:_context3.next=19;return Plugins.Storage.set({key:\"userPrivateKey\",value:privKey});case 19:_this.setState({userPublicKey:res.data.publicKey,userPrivateKey:privKey});console.log(\"Public and private key updated.\");return _context3.abrupt(\"return\",updateUserKeypair(res.data.publicKey,privKey,function(err){if(err){return console.log(err);}return console.log(\"User keypair updated.\");}));case 24:return _context3.abrupt(\"return\",console.log(\"Could not decrypt private key\"));case 25:_context3.next=49;break;case 27:_context3.prev=27;_context3.next=30;return window.crypto.subtle.generateKey({name:\"RSA-OAEP\",modulusLength:4096,publicExponent:new Uint8Array([1,0,1]),hash:\"SHA-512\"},true,[\"encrypt\",\"decrypt\"]);case 30:generatedKeypair=_context3.sent;_context3.next=33;return window.crypto.subtle.exportKey(\"spki\",generatedKeypair.publicKey);case 33:exportedPubKey=_context3.sent;b64PubKey=utils.base64ArrayBuffer(exportedPubKey);_context3.next=37;return window.crypto.subtle.exportKey(\"pkcs8\",generatedKeypair.privateKey);case 37:exportedPrivKey=_context3.sent;b64PrivKey=utils.base64ArrayBuffer(exportedPrivKey);if(!(b64PubKey.length>16&&b64PrivKey.length>16)){_context3.next=43;break;}setUserKeypair(b64PubKey,b64PrivKey,function(err){if(err){return console.log(err);}return console.log(\"User keypair generated and updated.\");});_context3.next=44;break;case 43:return _context3.abrupt(\"return\",console.log(\"Key lengths invalid\"));case 44:_context3.next=49;break;case 46:_context3.prev=46;_context3.t1=_context3[\"catch\"](27);return _context3.abrupt(\"return\",console.log(_context3.t1));case 49:case\"end\":return _context3.stop();}}},_callee3,null,[[0,6],[27,46]]);}));return function updatePubAndPrivKey(){return _ref3.apply(this,arguments);};}();_context4.prev=5;_context4.next=8;return utils.apiRequest(\"POST\",\"/v1/user/masterKeys\",{apiKey:this.state.userAPIKey,masterKeys:utils.cryptoJSEncrypt(this.state.userMasterKeys.join(\"|\"),this.state.userMasterKeys[this.state.userMasterKeys.length-1])});case 8:res=_context4.sent;_context4.next=14;break;case 11:_context4.prev=11;_context4.t0=_context4[\"catch\"](5);return _context4.abrupt(\"return\",console.log(_context4.t0));case 14:if(res.status){_context4.next=18;break;}if(!(res.message.toLowerCase().indexOf(\"api key not found\")!==-1)){_context4.next=17;break;}return _context4.abrupt(\"return\",window.customFunctions.logoutUser());case 17:return _context4.abrupt(\"return\",console.log(res.message));case 18:newKeys=\"\";this.state.userMasterKeys.forEach(function(key){try{if(newKeys.length==0){var decrypted=utils.cryptoJSDecrypt(res.data.keys,key);if(typeof decrypted==\"string\"){if(decrypted.length>16){newKeys=decrypted;}}}else{return;}}catch(e){console.log(e);return;}});if(!(newKeys.length>16)){_context4.next=27;break;}_context4.next=23;return Plugins.Storage.set({key:\"userMasterKeys\",value:JSON.stringify(newKeys.split(\"|\"))});case 23:this.setState({userMasterKeys:newKeys.split(\"|\")});console.log(\"Master keys updated.\");_context4.next=28;break;case 27:console.log(\"Could not decrypt master keys.\");case 28:return _context4.abrupt(\"return\",updatePubAndPrivKey());case 29:case\"end\":return _context4.stop();}}},_callee4,this,[[5,11]]);}));return _updateUserKeys.apply(this,arguments);}export function updateUserUsage(){return _updateUserUsage.apply(this,arguments);}function _updateUserUsage(){_updateUserUsage=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(){var res,storageUsedPercent;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(this.state.isLoggedIn){_context5.next=2;break;}return _context5.abrupt(\"return\",false);case 2:_context5.prev=2;_context5.next=5;return utils.apiRequest(\"POST\",\"/v1/user/usage\",{apiKey:this.state.userAPIKey});case 5:res=_context5.sent;_context5.next=11;break;case 8:_context5.prev=8;_context5.t0=_context5[\"catch\"](2);return _context5.abrupt(\"return\",console.log(_context5.t0));case 11:if(res.status){_context5.next=16;break;}console.log(res.message);if(!(res.message.toLowerCase().indexOf(\"api key not found\")!==-1)){_context5.next=15;break;}return _context5.abrupt(\"return\",window.customFunctions.logoutUser());case 15:return _context5.abrupt(\"return\",false);case 16:storageUsedPercent=(res.data.storage/res.data.max*100).toFixed(2);return _context5.abrupt(\"return\",this.setState({userStorageUsagePercentage:storageUsedPercent,userStorageUsageMenuText:language.get(\"en\",\"userStorageUsageMenuText\",false,[\"__MAX__\",\"__PERCENTAGE__\"],[utils.formatBytes(res.data.max),storageUsedPercent]),userCurrentStorageUsage:res.data.storage,userMaxStorage:res.data.max}));case 18:case\"end\":return _context5.stop();}}},_callee5,this,[[2,8]]);}));return _updateUserUsage.apply(this,arguments);}","map":{"version":3,"sources":["/Users/jan/Documents/filen/app/src/components/user.js"],"names":["language","Plugins","utils","require","updateUserKeys","state","isLoggedIn","updateUserKeypair","pub","priv","callback","apiRequest","apiKey","userAPIKey","publicKey","privateKey","cryptoJSEncrypt","userMasterKeys","length","res","console","log","status","message","toLowerCase","indexOf","window","customFunctions","logoutUser","setUserKeypair","updatePubAndPrivKey","data","privKey","forEach","key","decrypted","cryptoJSDecrypt","e","Storage","set","value","setState","userPublicKey","userPrivateKey","err","crypto","subtle","generateKey","name","modulusLength","publicExponent","Uint8Array","hash","generatedKeypair","exportKey","exportedPubKey","b64PubKey","base64ArrayBuffer","exportedPrivKey","b64PrivKey","masterKeys","join","newKeys","keys","JSON","stringify","split","updateUserUsage","storageUsedPercent","storage","max","toFixed","userStorageUsagePercentage","userStorageUsageMenuText","get","formatBytes","userCurrentStorageUsage","userMaxStorage"],"mappings":"uSAAA,MAAO,GAAKA,CAAAA,QAAZ,KAA0B,mBAA1B,CACA,OAASC,OAAT,KAAwB,iBAAxB,CAEA,GAAMC,CAAAA,KAAK,CAAGC,OAAO,CAAC,gBAAD,CAArB,CAEA,eAAsBC,CAAAA,cAAtB,iD,mGAAO,+NACC,KAAKC,KAAL,CAAWC,UADZ,2DAEQ,KAFR,SAKGC,iBALH,0FAKuB,iBAAOC,GAAP,CAAYC,IAAZ,CAAkBC,QAAlB,gKAEFR,CAAAA,KAAK,CAACS,UAAN,CAAiB,MAAjB,CAAyB,yBAAzB,CAAoD,CAChEC,MAAM,CAAE,KAAI,CAACP,KAAL,CAAWQ,UAD6C,CAEhEC,SAAS,CAAEN,GAFqD,CAGhEO,UAAU,CAAEb,KAAK,CAACc,eAAN,CAAsBP,IAAtB,CAA4B,KAAI,CAACJ,KAAL,CAAWY,cAAX,CAA0B,KAAI,CAACZ,KAAL,CAAWY,cAAX,CAA0BC,MAA1B,CAAmC,CAA7D,CAA5B,CAHoD,CAApD,CAFE,QAEdC,GAFc,mGASf,MAAOT,CAAAA,QAAP,EAAmB,UATJ,2DAUPA,QAAQ,aAVD,UAalBU,OAAO,CAACC,GAAR,cAbkB,gCAeX,KAfW,aAkBlBF,GAAG,CAACG,MAlBc,+BAmBf,MAAOZ,CAAAA,QAAP,EAAmB,UAnBJ,2DAoBPA,QAAQ,CAACS,GAAG,CAACI,OAAL,CApBD,UAuBlBH,OAAO,CAACC,GAAR,CAAYF,GAAG,CAACI,OAAhB,EAvBkB,KAyBfJ,GAAG,CAACI,OAAJ,CAAYC,WAAZ,GAA0BC,OAA1B,CAAkC,mBAAlC,IAA2D,CAAC,CAzB7C,2DA0BPC,MAAM,CAACC,eAAP,CAAuBC,UAAvB,EA1BO,0CA6BX,KA7BW,eAgCnB,MAAOlB,CAAAA,QAAP,EAAmB,UAhCA,2DAiCXA,QAAQ,CAAC,IAAD,CAAO,IAAP,CAjCG,0CAoCf,IApCe,sEALvB,kBAKGH,CAAAA,iBALH,qDA4CGsB,cA5CH,2FA4CoB,kBAAOrB,GAAP,CAAYC,IAAZ,CAAkBC,QAAlB,sKAECR,CAAAA,KAAK,CAACS,UAAN,CAAiB,MAAjB,CAAyB,sBAAzB,CAAiD,CAC7DC,MAAM,CAAE,KAAI,CAACP,KAAL,CAAWQ,UAD0C,CAE7DC,SAAS,CAAEN,GAFkD,CAG7DO,UAAU,CAAEb,KAAK,CAACc,eAAN,CAAsBP,IAAtB,CAA4B,KAAI,CAACJ,KAAL,CAAWY,cAAX,CAA0B,KAAI,CAACZ,KAAL,CAAWY,cAAX,CAA0BC,MAA1B,CAAmC,CAA7D,CAA5B,CAHiD,CAAjD,CAFD,QAEXC,GAFW,wGASZ,MAAOT,CAAAA,QAAP,EAAmB,UATP,6DAUJA,QAAQ,cAVJ,UAafU,OAAO,CAACC,GAAR,eAbe,iCAeR,KAfQ,aAkBfF,GAAG,CAACG,MAlBW,gCAmBZ,MAAOZ,CAAAA,QAAP,EAAmB,UAnBP,6DAoBJA,QAAQ,CAACS,GAAG,CAACI,OAAL,CApBJ,UAuBfH,OAAO,CAACC,GAAR,CAAYF,GAAG,CAACI,OAAhB,EAvBe,KAyBZJ,GAAG,CAACI,OAAJ,CAAYC,WAAZ,GAA0BC,OAA1B,CAAkC,mBAAlC,IAA2D,CAAC,CAzBhD,6DA0BJC,MAAM,CAACC,eAAP,CAAuBC,UAAvB,EA1BI,2CA6BR,KA7BQ,eAgChB,MAAOlB,CAAAA,QAAP,EAAmB,UAhCH,6DAiCRA,QAAQ,CAAC,IAAD,CAAO,IAAP,CAjCA,2CAoCZ,IApCY,wEA5CpB,kBA4CGmB,CAAAA,cA5CH,uDAmFGC,mBAnFH,2FAmFyB,qQAEJ5B,CAAAA,KAAK,CAACS,UAAN,CAAiB,MAAjB,CAAyB,uBAAzB,CAAkD,CAC9DC,MAAM,CAAE,KAAI,CAACP,KAAL,CAAWQ,UAD2C,CAAlD,CAFI,QAEhBM,GAFgB,mIAObC,OAAO,CAACC,GAAR,cAPa,YAUpBF,GAAG,CAACG,MAVgB,4DAWbF,OAAO,CAACC,GAAR,CAAYF,GAAG,CAACI,OAAhB,CAXa,eAcrBJ,GAAG,CAACY,IAAJ,CAASjB,SAAT,CAAmBI,MAAnB,CAA4B,EAA5B,EAAkCC,GAAG,CAACY,IAAJ,CAAShB,UAAT,CAAoBG,MAApB,CAA6B,EAd1C,4BAehBc,OAfgB,CAeN,EAfM,CAiBpB,KAAI,CAAC3B,KAAL,CAAWY,cAAX,CAA0BgB,OAA1B,CAAkC,SAACC,GAAD,CAAS,CACvC,GAAGF,OAAO,CAACd,MAAR,EAAkB,CAArB,CAAuB,CACnB,GAAG,CACC,GAAIiB,CAAAA,SAAS,CAAGjC,KAAK,CAACkC,eAAN,CAAsBjB,GAAG,CAACY,IAAJ,CAAShB,UAA/B,CAA2CmB,GAA3C,CAAhB,CAEA,GAAG,MAAOC,CAAAA,SAAP,EAAoB,QAAvB,CAAgC,CAC5B,GAAGA,SAAS,CAACjB,MAAV,CAAmB,EAAtB,CAAyB,CACrBc,OAAO,CAAGG,SAAV,CACH,CACJ,CACJ,CACD,MAAME,CAAN,CAAQ,CACJjB,OAAO,CAACC,GAAR,CAAYgB,CAAZ,EAEA,OACH,CACJ,CACJ,CAjBD,EAjBoB,KAoCjBL,OAAO,CAACd,MAAR,CAAiB,EApCA,oDAqCVjB,CAAAA,OAAO,CAACqC,OAAR,CAAgBC,GAAhB,CAAoB,CAAEL,GAAG,CAAE,eAAP,CAAwBM,KAAK,CAAErB,GAAG,CAACY,IAAJ,CAASjB,SAAxC,CAApB,CArCU,iCAsCVb,CAAAA,OAAO,CAACqC,OAAR,CAAgBC,GAAhB,CAAoB,CAAEL,GAAG,CAAE,gBAAP,CAAyBM,KAAK,CAAER,OAAhC,CAApB,CAtCU,SAwChB,KAAI,CAACS,QAAL,CAAc,CACVC,aAAa,CAAEvB,GAAG,CAACY,IAAJ,CAASjB,SADd,CAEV6B,cAAc,CAAEX,OAFN,CAAd,EAKAZ,OAAO,CAACC,GAAR,CAAY,iCAAZ,EA7CgB,iCA+CTd,iBAAiB,CAACY,GAAG,CAACY,IAAJ,CAASjB,SAAV,CAAqBkB,OAArB,CAA8B,SAACY,GAAD,CAAS,CAC3D,GAAGA,GAAH,CAAO,CACH,MAAOxB,CAAAA,OAAO,CAACC,GAAR,CAAYuB,GAAZ,CAAP,CACH,CAED,MAAOxB,CAAAA,OAAO,CAACC,GAAR,CAAY,uBAAZ,CAAP,CACH,CANuB,CA/CR,2CAwDTD,OAAO,CAACC,GAAR,CAAY,+BAAZ,CAxDS,oFA6DaK,CAAAA,MAAM,CAACmB,MAAP,CAAcC,MAAd,CAAqBC,WAArB,CAAiC,CAC1DC,IAAI,CAAE,UADoD,CAE1DC,aAAa,CAAE,IAF2C,CAG1DC,cAAc,CAAE,GAAIC,CAAAA,UAAJ,CAAe,CAAC,CAAD,CAAI,CAAJ,CAAO,CAAP,CAAf,CAH0C,CAI1DC,IAAI,CAAE,SAJoD,CAAjC,CAK1B,IAL0B,CAKpB,CAAC,SAAD,CAAY,SAAZ,CALoB,CA7Db,SA6DZC,gBA7DY,wCAoEW3B,CAAAA,MAAM,CAACmB,MAAP,CAAcC,MAAd,CAAqBQ,SAArB,CAA+B,MAA/B,CAAuCD,gBAAgB,CAACvC,SAAxD,CApEX,SAoEZyC,cApEY,gBAqEZC,SArEY,CAqEAtD,KAAK,CAACuD,iBAAN,CAAwBF,cAAxB,CArEA,yBAuEY7B,CAAAA,MAAM,CAACmB,MAAP,CAAcC,MAAd,CAAqBQ,SAArB,CAA+B,OAA/B,CAAwCD,gBAAgB,CAACtC,UAAzD,CAvEZ,SAuEZ2C,eAvEY,gBAwEZC,UAxEY,CAwECzD,KAAK,CAACuD,iBAAN,CAAwBC,eAAxB,CAxED,MA0EbF,SAAS,CAACtC,MAAV,CAAmB,EAAnB,EAAyByC,UAAU,CAACzC,MAAX,CAAoB,EA1EhC,4BA2EZW,cAAc,CAAC2B,SAAD,CAAYG,UAAZ,CAAwB,SAACf,GAAD,CAAS,CAC3C,GAAGA,GAAH,CAAO,CACH,MAAOxB,CAAAA,OAAO,CAACC,GAAR,CAAYuB,GAAZ,CAAP,CACH,CAED,MAAOxB,CAAAA,OAAO,CAACC,GAAR,CAAY,qCAAZ,CAAP,CACH,CANa,CAAd,CA3EY,iEAoFLD,OAAO,CAACC,GAAR,CAAY,qBAAZ,CApFK,iIAwFTD,OAAO,CAACC,GAAR,cAxFS,gFAnFzB,kBAmFGS,CAAAA,mBAnFH,oFAiLiB5B,CAAAA,KAAK,CAACS,UAAN,CAAiB,MAAjB,CAAyB,qBAAzB,CAAgD,CAC5DC,MAAM,CAAE,KAAKP,KAAL,CAAWQ,UADyC,CAE5D+C,UAAU,CAAE1D,KAAK,CAACc,eAAN,CAAsB,KAAKX,KAAL,CAAWY,cAAX,CAA0B4C,IAA1B,CAA+B,GAA/B,CAAtB,CAA2D,KAAKxD,KAAL,CAAWY,cAAX,CAA0B,KAAKZ,KAAL,CAAWY,cAAX,CAA0BC,MAA1B,CAAmC,CAA7D,CAA3D,CAFgD,CAAhD,CAjLjB,QAiLKC,GAjLL,sIAuLQC,OAAO,CAACC,GAAR,cAvLR,aA0LCF,GAAG,CAACG,MA1LL,gCA2LIH,GAAG,CAACI,OAAJ,CAAYC,WAAZ,GAA0BC,OAA1B,CAAkC,mBAAlC,IAA2D,CAAC,CA3LhE,6DA4LYC,MAAM,CAACC,eAAP,CAAuBC,UAAvB,EA5LZ,2CA+LQR,OAAO,CAACC,GAAR,CAAYF,GAAG,CAACI,OAAhB,CA/LR,UAkMCuC,OAlMD,CAkMW,EAlMX,CAoMH,KAAKzD,KAAL,CAAWY,cAAX,CAA0BgB,OAA1B,CAAkC,SAACC,GAAD,CAAS,CACvC,GAAG,CACC,GAAG4B,OAAO,CAAC5C,MAAR,EAAkB,CAArB,CAAuB,CACnB,GAAIiB,CAAAA,SAAS,CAAGjC,KAAK,CAACkC,eAAN,CAAsBjB,GAAG,CAACY,IAAJ,CAASgC,IAA/B,CAAqC7B,GAArC,CAAhB,CAEA,GAAG,MAAOC,CAAAA,SAAP,EAAoB,QAAvB,CAAgC,CAC5B,GAAGA,SAAS,CAACjB,MAAV,CAAmB,EAAtB,CAAyB,CACrB4C,OAAO,CAAG3B,SAAV,CACH,CACJ,CACJ,CARD,IASI,CACA,OACH,CACJ,CACD,MAAME,CAAN,CAAQ,CACJjB,OAAO,CAACC,GAAR,CAAYgB,CAAZ,EAEA,OACH,CACJ,CApBD,EApMG,KA0NAyB,OAAO,CAAC5C,MAAR,CAAiB,EA1NjB,oDA2NOjB,CAAAA,OAAO,CAACqC,OAAR,CAAgBC,GAAhB,CAAoB,CAAEL,GAAG,CAAE,gBAAP,CAAyBM,KAAK,CAAEwB,IAAI,CAACC,SAAL,CAAeH,OAAO,CAACI,KAAR,CAAc,GAAd,CAAf,CAAhC,CAApB,CA3NP,SA6NC,KAAKzB,QAAL,CAAc,CACVxB,cAAc,CAAE6C,OAAO,CAACI,KAAR,CAAc,GAAd,CADN,CAAd,EAIA9C,OAAO,CAACC,GAAR,CAAY,sBAAZ,EAjOD,gCAoOCD,OAAO,CAACC,GAAR,CAAY,gCAAZ,EApOD,yCAuOIS,mBAAmB,EAvOvB,yE,iDA0OP,eAAsBqC,CAAAA,eAAtB,kD,qGAAO,sKACC,KAAK9D,KAAL,CAAWC,UADZ,2DAEQ,KAFR,iDAMiBJ,CAAAA,KAAK,CAACS,UAAN,CAAiB,MAAjB,CAAyB,gBAAzB,CAA2C,CACvDC,MAAM,CAAE,KAAKP,KAAL,CAAWQ,UADoC,CAA3C,CANjB,QAMKM,GANL,oIAWQC,OAAO,CAACC,GAAR,cAXR,aAcCF,GAAG,CAACG,MAdL,2BAeCF,OAAO,CAACC,GAAR,CAAYF,GAAG,CAACI,OAAhB,EAfD,KAiBIJ,GAAG,CAACI,OAAJ,CAAYC,WAAZ,GAA0BC,OAA1B,CAAkC,mBAAlC,IAA2D,CAAC,CAjBhE,6DAkBYC,MAAM,CAACC,eAAP,CAAuBC,UAAvB,EAlBZ,2CAqBQ,KArBR,UAwBCwC,kBAxBD,CAwBsB,CAAEjD,GAAG,CAACY,IAAJ,CAASsC,OAAT,CAAmBlD,GAAG,CAACY,IAAJ,CAASuC,GAA7B,CAAoC,GAArC,EAA0CC,OAA1C,CAAkD,CAAlD,CAxBtB,kCA0BI,KAAK9B,QAAL,CAAc,CACjB+B,0BAA0B,CAAEJ,kBADX,CAEjBK,wBAAwB,CAAEzE,QAAQ,CAAC0E,GAAT,CAAa,IAAb,CAAmB,0BAAnB,CAA+C,KAA/C,CAAsD,CAAC,SAAD,CAAY,gBAAZ,CAAtD,CAAqF,CAACxE,KAAK,CAACyE,WAAN,CAAkBxD,GAAG,CAACY,IAAJ,CAASuC,GAA3B,CAAD,CAAkCF,kBAAlC,CAArF,CAFT,CAGvBQ,uBAAuB,CAAEzD,GAAG,CAACY,IAAJ,CAASsC,OAHX,CAIvBQ,cAAc,CAAE1D,GAAG,CAACY,IAAJ,CAASuC,GAJF,CAAd,CA1BJ,wE","sourcesContent":["import * as language from \"../utils/language\"\r\nimport { Plugins } from \"@capacitor/core\"\r\n\r\nconst utils = require(\"../utils/utils\")\r\n\r\nexport async function updateUserKeys(){\r\n    if(!this.state.isLoggedIn){\r\n        return false\r\n    }\r\n\r\n    const updateUserKeypair = async (pub, priv, callback) => {\r\n        try{\r\n            var res = await utils.apiRequest(\"POST\", \"/v1/user/keyPair/update\", {\r\n                apiKey: this.state.userAPIKey,\r\n                publicKey: pub,\r\n                privateKey: utils.cryptoJSEncrypt(priv, this.state.userMasterKeys[this.state.userMasterKeys.length - 1])\r\n            })\r\n        }\r\n        catch(e){\r\n            if(typeof callback == \"function\"){\r\n                return callback(e)\r\n            }\r\n\r\n            console.log(e)\r\n\r\n            return false\r\n        }\r\n\r\n        if(!res.status){\r\n            if(typeof callback == \"function\"){\r\n                return callback(res.message)\r\n            }\r\n\r\n            console.log(res.message)\r\n\r\n            if(res.message.toLowerCase().indexOf(\"api key not found\") !== -1){\r\n                return window.customFunctions.logoutUser()\r\n            }\r\n\r\n            return false\r\n        }\r\n\r\n        if(typeof callback == \"function\"){\r\n            return callback(null, true)\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    const setUserKeypair = async (pub, priv, callback) => {\r\n        try{\r\n            var res = await utils.apiRequest(\"POST\", \"/v1/user/keyPair/set\", {\r\n                apiKey: this.state.userAPIKey,\r\n                publicKey: pub,\r\n                privateKey: utils.cryptoJSEncrypt(priv, this.state.userMasterKeys[this.state.userMasterKeys.length - 1])\r\n            })\r\n        }\r\n        catch(e){\r\n            if(typeof callback == \"function\"){\r\n                return callback(e)\r\n            }\r\n\r\n            console.log(e)\r\n\r\n            return false\r\n        }\r\n\r\n        if(!res.status){\r\n            if(typeof callback == \"function\"){\r\n                return callback(res.message)\r\n            }\r\n\r\n            console.log(res.message)\r\n\r\n            if(res.message.toLowerCase().indexOf(\"api key not found\") !== -1){\r\n                return window.customFunctions.logoutUser()\r\n            }\r\n\r\n            return false\r\n        }\r\n\r\n        if(typeof callback == \"function\"){\r\n            return callback(null, true)\r\n        }\r\n\r\n        return true\r\n    }\r\n\r\n    const updatePubAndPrivKey = async () => {\r\n        try{\r\n            var res = await utils.apiRequest(\"POST\", \"/v1/user/keyPair/info\", {\r\n                apiKey: this.state.userAPIKey\r\n            })\r\n        }\r\n        catch(e){\r\n            return console.log(e)\r\n        }\r\n\r\n        if(!res.status){\r\n            return console.log(res.message)\r\n        }\r\n\r\n        if(res.data.publicKey.length > 16 && res.data.privateKey.length > 16){\r\n            let privKey = \"\"\r\n\r\n            this.state.userMasterKeys.forEach((key) => {\r\n                if(privKey.length == 0){\r\n                    try{\r\n                        let decrypted = utils.cryptoJSDecrypt(res.data.privateKey, key)\r\n\r\n                        if(typeof decrypted == \"string\"){\r\n                            if(decrypted.length > 16){\r\n                                privKey = decrypted\r\n                            }\r\n                        }\r\n                    }\r\n                    catch(e){\r\n                        console.log(e)\r\n\r\n                        return\r\n                    }\r\n                }\r\n            })\r\n\r\n            if(privKey.length > 16){\r\n                await Plugins.Storage.set({ key: \"userPublicKey\", value: res.data.publicKey })\r\n                await Plugins.Storage.set({ key: \"userPrivateKey\", value: privKey })\r\n\r\n                this.setState({\r\n                    userPublicKey: res.data.publicKey,\r\n                    userPrivateKey: privKey\r\n                })\r\n\r\n                console.log(\"Public and private key updated.\")\r\n\r\n                return updateUserKeypair(res.data.publicKey, privKey, (err) => {\r\n                    if(err){\r\n                        return console.log(err)\r\n                    }\r\n\r\n                    return console.log(\"User keypair updated.\")\r\n                })\r\n            }\r\n            else{\r\n                return console.log(\"Could not decrypt private key\")\r\n            }\r\n        }\r\n        else{\r\n            try{\r\n                let generatedKeypair = await window.crypto.subtle.generateKey({\r\n                    name: \"RSA-OAEP\",\r\n                    modulusLength: 4096,\r\n                    publicExponent: new Uint8Array([1, 0, 1]),\r\n                    hash: \"SHA-512\"\r\n                }, true, [\"encrypt\", \"decrypt\"])\r\n\r\n                let exportedPubKey = await window.crypto.subtle.exportKey(\"spki\", generatedKeypair.publicKey)\r\n                let b64PubKey = utils.base64ArrayBuffer(exportedPubKey)\r\n\r\n                let exportedPrivKey = await window.crypto.subtle.exportKey(\"pkcs8\", generatedKeypair.privateKey)\r\n                let b64PrivKey = utils.base64ArrayBuffer(exportedPrivKey)\r\n\r\n                if(b64PubKey.length > 16 && b64PrivKey.length > 16){\r\n                    setUserKeypair(b64PubKey, b64PrivKey, (err) => {\r\n                        if(err){\r\n                            return console.log(err)\r\n                        }\r\n\r\n                        return console.log(\"User keypair generated and updated.\")\r\n                    })\r\n                }\r\n                else{\r\n                    return console.log(\"Key lengths invalid\")\r\n                }\r\n            }\r\n            catch(e){\r\n                return console.log(e)\r\n            }\r\n        }\r\n    }\r\n\r\n    try{\r\n        var res = await utils.apiRequest(\"POST\", \"/v1/user/masterKeys\", {\r\n            apiKey: this.state.userAPIKey,\r\n            masterKeys: utils.cryptoJSEncrypt(this.state.userMasterKeys.join(\"|\"), this.state.userMasterKeys[this.state.userMasterKeys.length - 1])\r\n        })\r\n    }\r\n    catch(e){\r\n        return console.log(e)\r\n    }\r\n\r\n    if(!res.status){\r\n        if(res.message.toLowerCase().indexOf(\"api key not found\") !== -1){\r\n            return window.customFunctions.logoutUser()\r\n        }\r\n\r\n        return console.log(res.message)\r\n    }\r\n\r\n    let newKeys = \"\"\r\n\r\n    this.state.userMasterKeys.forEach((key) => {\r\n        try{\r\n            if(newKeys.length == 0){\r\n                let decrypted = utils.cryptoJSDecrypt(res.data.keys, key)\r\n\r\n                if(typeof decrypted == \"string\"){\r\n                    if(decrypted.length > 16){\r\n                        newKeys = decrypted\r\n                    }\r\n                }\r\n            }\r\n            else{\r\n                return\r\n            }\r\n        }\r\n        catch(e){\r\n            console.log(e)\r\n\r\n            return\r\n        }\r\n    })\r\n\r\n    if(newKeys.length > 16){\r\n        await Plugins.Storage.set({ key: \"userMasterKeys\", value: JSON.stringify(newKeys.split(\"|\")) })\r\n\r\n        this.setState({\r\n            userMasterKeys: newKeys.split(\"|\")\r\n        })\r\n\r\n        console.log(\"Master keys updated.\")\r\n    }\r\n    else{\r\n        console.log(\"Could not decrypt master keys.\")\r\n    }\r\n\r\n    return updatePubAndPrivKey()\r\n}\r\n\r\nexport async function updateUserUsage(){\r\n    if(!this.state.isLoggedIn){\r\n        return false\r\n    }\r\n\r\n    try{\r\n        var res = await utils.apiRequest(\"POST\", \"/v1/user/usage\", {\r\n            apiKey: this.state.userAPIKey\r\n        })\r\n    }\r\n    catch(e){\r\n        return console.log(e)\r\n    }\r\n\r\n    if(!res.status){\r\n        console.log(res.message)\r\n\r\n        if(res.message.toLowerCase().indexOf(\"api key not found\") !== -1){\r\n            return window.customFunctions.logoutUser()\r\n        }\r\n\r\n        return false\r\n    }\r\n\r\n    let storageUsedPercent = ((res.data.storage / res.data.max) * 100).toFixed(2)\r\n\r\n    return this.setState({\r\n        userStorageUsagePercentage: storageUsedPercent,\r\n        userStorageUsageMenuText: language.get(\"en\", \"userStorageUsageMenuText\", false, [\"__MAX__\", \"__PERCENTAGE__\"], [utils.formatBytes(res.data.max), storageUsedPercent]),\r\n\t\tuserCurrentStorageUsage: res.data.storage,\r\n\t\tuserMaxStorage: res.data.max\r\n    })\r\n}"]},"metadata":{},"sourceType":"module"}