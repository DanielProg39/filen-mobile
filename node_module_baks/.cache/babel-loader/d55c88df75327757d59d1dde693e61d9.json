{"ast":null,"code":"import _regeneratorRuntime from\"/Users/jan/Documents/filen/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/jan/Documents/filen/app/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import*as language from\"../utils/language\";import*as workers from\"../utils/workers\";import{Capacitor,FilesystemDirectory,Plugins}from\"@capacitor/core\";import imageCompression from'browser-image-compression';import{call}from\"ionicons/icons\";var utils=require(\"../utils/utils\");export function getThumbnailDir(_x,_x2){return _getThumbnailDir.apply(this,arguments);}function _getThumbnailDir(){_getThumbnailDir=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(uuid,callback){var path,directory,uri,_path,_directory;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!(Capacitor.platform==\"android\")){_context.next=30;break;}path=\"ThumbnailCache/\"+uuid;directory=FilesystemDirectory.External;_context.prev=3;_context.next=6;return Plugins.Filesystem.mkdir({path:path,directory:directory,recursive:true});case 6:_context.next=8;return Plugins.Filesystem.getUri({path:path,directory:directory});case 8:uri=_context.sent;return _context.abrupt(\"return\",callback(null,{path:path,directory:directory,uri:uri}));case 12:_context.prev=12;_context.t0=_context[\"catch\"](3);if(!(_context.t0.message==\"Directory exists\")){_context.next=27;break;}_context.prev=15;_context.next=18;return Plugins.Filesystem.getUri({path:path,directory:directory});case 18:uri=_context.sent;return _context.abrupt(\"return\",callback(null,{path:path,directory:directory,uri:uri}));case 22:_context.prev=22;_context.t1=_context[\"catch\"](15);return _context.abrupt(\"return\",callback(_context.t1));case 25:_context.next=28;break;case 27:return _context.abrupt(\"return\",callback(_context.t0));case 28:_context.next=61;break;case 30:if(!(Capacitor.platform==\"ios\")){_context.next=60;break;}_path=\"FilenThumbnailCache/\"+uuid;_directory=FilesystemDirectory.Documents;_context.prev=33;_context.next=36;return Plugins.Filesystem.mkdir({path:_path,directory:_directory,recursive:true});case 36:_context.next=38;return Plugins.Filesystem.getUri({path:_path,directory:_directory});case 38:uri=_context.sent;return _context.abrupt(\"return\",callback(null,{path:_path,directory:_directory,uri:uri}));case 42:_context.prev=42;_context.t2=_context[\"catch\"](33);if(!(_context.t2.message==\"Directory exists\")){_context.next=57;break;}_context.prev=45;_context.next=48;return Plugins.Filesystem.getUri({path:_path,directory:_directory});case 48:uri=_context.sent;return _context.abrupt(\"return\",callback(null,{path:_path,directory:_directory,uri:uri}));case 52:_context.prev=52;_context.t3=_context[\"catch\"](45);return _context.abrupt(\"return\",callback(_context.t3));case 55:_context.next=58;break;case 57:return _context.abrupt(\"return\",callback(_context.t2));case 58:_context.next=61;break;case 60:return _context.abrupt(\"return\",callback(new Error(\"Can only run getdir function on native ios or android device\")));case 61:case\"end\":return _context.stop();}}},_callee,null,[[3,12],[15,22],[33,42],[45,52]]);}));return _getThumbnailDir.apply(this,arguments);}export function getDownloadDir(_x3,_x4,_x5){return _getDownloadDir.apply(this,arguments);}function _getDownloadDir(){_getDownloadDir=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(makeOffline,fileName,callback){var path,directory,uri,_path2,_directory2,_path3,_directory3,_path4,_directory4;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:if(!(Capacitor.platform==\"android\")){_context2.next=86;break;}if(!makeOffline){_context2.next=31;break;}path=\"OfflineFiles/\"+fileName;directory=FilesystemDirectory.External;_context2.prev=4;_context2.next=7;return Plugins.Filesystem.mkdir({path:path,directory:directory,recursive:true});case 7:_context2.next=9;return Plugins.Filesystem.getUri({path:path,directory:directory});case 9:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:path,directory:directory,uri:uri}));case 13:_context2.prev=13;_context2.t0=_context2[\"catch\"](4);if(!(_context2.t0.message==\"Directory exists\")){_context2.next=28;break;}_context2.prev=16;_context2.next=19;return Plugins.Filesystem.getUri({path:path,directory:directory});case 19:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:path,directory:directory,uri:uri}));case 23:_context2.prev=23;_context2.t1=_context2[\"catch\"](16);return _context2.abrupt(\"return\",callback(_context2.t1));case 26:_context2.next=29;break;case 28:return _context2.abrupt(\"return\",callback(_context2.t0));case 29:_context2.next=84;break;case 31:_path2=\"Download\";_directory2=FilesystemDirectory.ExternalStorage;_context2.prev=33;_context2.next=36;return Plugins.Filesystem.mkdir({path:_path2,directory:_directory2,recursive:true});case 36:_context2.next=38;return Plugins.Filesystem.getUri({path:_path2,directory:_directory2});case 38:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:_path2,directory:_directory2,uri:uri}));case 42:_context2.prev=42;_context2.t2=_context2[\"catch\"](33);if(!(_context2.t2.message==\"Directory exists\")){_context2.next=57;break;}_context2.prev=45;_context2.next=48;return Plugins.Filesystem.getUri({path:_path2,directory:_directory2});case 48:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:_path2,directory:_directory2,uri:uri}));case 52:_context2.prev=52;_context2.t3=_context2[\"catch\"](45);return _context2.abrupt(\"return\",callback(_context2.t3));case 55:_context2.next=84;break;case 57:_path2=\"Downloads\";_directory2=FilesystemDirectory.External;_context2.prev=59;_context2.next=62;return Plugins.Filesystem.mkdir({path:_path2,directory:_directory2,recursive:true});case 62:_context2.next=64;return Plugins.Filesystem.getUri({path:_path2,directory:_directory2});case 64:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:_path2,directory:_directory2,uri:uri}));case 68:_context2.prev=68;_context2.t4=_context2[\"catch\"](59);if(!(_context2.t4.message==\"Directory exists\")){_context2.next=83;break;}_context2.prev=71;_context2.next=74;return Plugins.Filesystem.getUri({path:_path2,directory:_directory2});case 74:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:_path2,directory:_directory2,uri:uri}));case 78:_context2.prev=78;_context2.t5=_context2[\"catch\"](71);return _context2.abrupt(\"return\",callback(_context2.t5));case 81:_context2.next=84;break;case 83:return _context2.abrupt(\"return\",callback(_context2.t4));case 84:_context2.next=147;break;case 86:if(!(Capacitor.platform==\"ios\")){_context2.next=146;break;}if(!makeOffline){_context2.next=117;break;}_path3=\"FilenOfflineFiles/\"+fileName;_directory3=FilesystemDirectory.Documents;_context2.prev=90;_context2.next=93;return Plugins.Filesystem.mkdir({path:_path3,directory:_directory3,recursive:true});case 93:_context2.next=95;return Plugins.Filesystem.getUri({path:_path3,directory:_directory3});case 95:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:_path3,directory:_directory3,uri:uri}));case 99:_context2.prev=99;_context2.t6=_context2[\"catch\"](90);if(!(_context2.t6.message==\"Directory exists\")){_context2.next=114;break;}_context2.prev=102;_context2.next=105;return Plugins.Filesystem.getUri({path:_path3,directory:_directory3});case 105:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:_path3,directory:_directory3,uri:uri}));case 109:_context2.prev=109;_context2.t7=_context2[\"catch\"](102);return _context2.abrupt(\"return\",callback(_context2.t7));case 112:_context2.next=115;break;case 114:return _context2.abrupt(\"return\",callback(_context2.t6));case 115:_context2.next=144;break;case 117:_path4=\"Filen Downloads\";_directory4=FilesystemDirectory.ExternalStorage;_context2.prev=119;_context2.next=122;return Plugins.Filesystem.mkdir({path:_path4,directory:_directory4,recursive:true});case 122:_context2.next=124;return Plugins.Filesystem.getUri({path:_path4,directory:_directory4});case 124:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:_path4,directory:_directory4,uri:uri}));case 128:_context2.prev=128;_context2.t8=_context2[\"catch\"](119);if(!(_context2.t8.message==\"Directory exists\")){_context2.next=143;break;}_context2.prev=131;_context2.next=134;return Plugins.Filesystem.getUri({path:_path4,directory:_directory4});case 134:uri=_context2.sent;return _context2.abrupt(\"return\",callback(null,{path:_path4,directory:_directory4,uri:uri}));case 138:_context2.prev=138;_context2.t9=_context2[\"catch\"](131);return _context2.abrupt(\"return\",callback(_context2.t9));case 141:_context2.next=144;break;case 143:return _context2.abrupt(\"return\",callback(_context2.t8));case 144:_context2.next=147;break;case 146:return _context2.abrupt(\"return\",callback(new Error(\"Can only run getdir function on native ios or android device\")));case 147:case\"end\":return _context2.stop();}}},_callee2,null,[[4,13],[16,23],[33,42],[45,52],[59,68],[71,78],[90,99],[102,109],[119,128],[131,138]]);}));return _getDownloadDir.apply(this,arguments);}export function downloadFileChunk(_x6,_x7,_x8,_x9,_x10){return _downloadFileChunk.apply(this,arguments);}function _downloadFileChunk(){_downloadFileChunk=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee3(file,index,tries,maxTries,callback){var _this=this;return _regeneratorRuntime.wrap(function _callee3$(_context3){while(1){switch(_context3.prev=_context3.next){case 0:if(!(tries>=maxTries)){_context3.next=2;break;}return _context3.abrupt(\"return\",callback(new Error(\"Max download retries reached for \"+file.uuid+\", returning.\")));case 2:if(!(index>=file.chunks)){_context3.next=4;break;}return _context3.abrupt(\"return\",callback(null,index));case 4:if(!(typeof window.customVariables.stoppedDownloads[file.uuid]!==\"undefined\")){_context3.next=6;break;}return _context3.abrupt(\"return\",callback(\"stopped\"));case 6:_context3.next=8;return window.customVariables.downloadChunkSemaphore.acquire();case 8:utils.fetchWithTimeout(3600000,fetch(utils.getDownloadServer()+\"/\"+file.region+\"/\"+file.bucket+\"/\"+file.uuid+\"/\"+index,{method:\"GET\"})).then(function(response){response.arrayBuffer().then(function(res){if(typeof window.customVariables.stoppedDownloads[file.uuid]!==\"undefined\"){return callback(\"stopped\");}try{if(res.byteLength){if(res.byteLength>1){workers.decryptData(file.uuid,index,file.key,res,function(decrypted){window.customVariables.downloadChunkSemaphore.release();return callback(null,index,decrypted);});}else{window.customVariables.downloadChunkSemaphore.release();return setTimeout(function(){_this.downloadFileChunk(file,index,tries+1,maxTries,callback);},1000);}}else{window.customVariables.downloadChunkSemaphore.release();return setTimeout(function(){_this.downloadFileChunk(file,index,tries+1,maxTries,callback);},1000);}}catch(e){console.log(e);window.customVariables.downloadChunkSemaphore.release();return setTimeout(function(){_this.downloadFileChunk(file,index,tries+1,maxTries,callback);},1000);}}).catch(function(err){console.log(err);window.customVariables.downloadChunkSemaphore.release();return setTimeout(function(){_this.downloadFileChunk(file,index,tries+1,maxTries,callback);},1000);});}).catch(function(err){console.log(err);window.customVariables.downloadChunkSemaphore.release();return setTimeout(function(){_this.downloadFileChunk(file,index,tries+1,maxTries,callback);},1000);});case 9:case\"end\":return _context3.stop();}}},_callee3);}));return _downloadFileChunk.apply(this,arguments);}export function writeChunkToFile(_x11,_x12,_x13,_x14,_x15,_x16){return _writeChunkToFile.apply(this,arguments);}function _writeChunkToFile(){_writeChunkToFile=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee5(file,dirObj,uuid,index,data,callback){var _this2=this;return _regeneratorRuntime.wrap(function _callee5$(_context5){while(1){switch(_context5.prev=_context5.next){case 0:if(window.customVariables.downloads[uuid]){_context5.next=2;break;}return _context5.abrupt(\"return\",callback(new Error(\"Download does not exist\")));case 2:if(!(window.customVariables.downloads[uuid].nextWriteChunk!==index)){_context5.next=4;break;}return _context5.abrupt(\"return\",setTimeout(function(){_this2.writeChunkToFile(file,dirObj,uuid,index,data,callback);},50));case 4:if(!(index==0)){_context5.next=13;break;}_context5.prev=5;_context5.next=8;return Plugins.Filesystem.deleteFile({path:dirObj.path+\"/\"+file.name,directory:dirObj.directory});case 8:_context5.next=13;break;case 10:_context5.prev=10;_context5.t0=_context5[\"catch\"](5);console.log(_context5.t0);case 13:workers.convertArrayBufferToBase64(data,/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee4(b64Data){return _regeneratorRuntime.wrap(function _callee4$(_context4){while(1){switch(_context4.prev=_context4.next){case 0:if(!(index==0)){_context4.next=12;break;}_context4.prev=1;_context4.next=4;return Plugins.Filesystem.writeFile({path:dirObj.path+\"/\"+file.name,directory:dirObj.directory,data:b64Data,recursive:true});case 4:return _context4.abrupt(\"return\",callback(null));case 7:_context4.prev=7;_context4.t0=_context4[\"catch\"](1);return _context4.abrupt(\"return\",callback(_context4.t0));case 10:_context4.next=21;break;case 12:_context4.prev=12;_context4.next=15;return Plugins.Filesystem.appendFile({path:dirObj.path+\"/\"+file.name,directory:dirObj.directory,data:b64Data});case 15:return _context4.abrupt(\"return\",callback(null));case 18:_context4.prev=18;_context4.t1=_context4[\"catch\"](12);return _context4.abrupt(\"return\",callback(_context4.t1));case 21:case\"end\":return _context4.stop();}}},_callee4,null,[[1,7],[12,18]]);}));return function(_x24){return _ref.apply(this,arguments);};}());case 14:case\"end\":return _context5.stop();}}},_callee5,null,[[5,10]]);}));return _writeChunkToFile.apply(this,arguments);}export function queueFileDownload(_x17){return _queueFileDownload.apply(this,arguments);}function _queueFileDownload(){_queueFileDownload=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee9(file){var _this3=this;var networkStatus,prop,uuid,name,size,currentIndex,ext,makeOffline,fileName;return _regeneratorRuntime.wrap(function _callee9$(_context9){while(1){switch(_context9.prev=_context9.next){case 0:if(!Capacitor.isNative){_context9.next=7;break;}if(!this.state.settings.onlyWifi){_context9.next=7;break;}_context9.next=4;return Plugins.Network.getStatus();case 4:networkStatus=_context9.sent;if(!(networkStatus.connectionType!==\"wifi\")){_context9.next=7;break;}return _context9.abrupt(\"return\",this.spawnToast(language.get(this.state.lang,\"onlyWifiError\")));case 7:_context9.t0=_regeneratorRuntime.keys(window.customVariables.downloads);case 8:if((_context9.t1=_context9.t0()).done){_context9.next=14;break;}prop=_context9.t1.value;if(!(window.customVariables.downloads[prop].name==file.name)){_context9.next=12;break;}return _context9.abrupt(\"return\",this.spawnToast(language.get(this.state.lang,\"fileDownloadAlreadyDownloadingFile\",true,[\"__NAME__\"],[file.name])));case 12:_context9.next=8;break;case 14:uuid=file.uuid;name=file.name;size=file.size;currentIndex=-1;ext=file.name.split(\".\");ext=ext[ext.length-1].toLowerCase();makeOffline=false;fileName=file.name;window.customVariables.stoppedDownloads[uuid]=undefined;window.customVariables.stoppedDownloadsDone[uuid]=undefined;if(!(typeof file.makeOffline!==\"undefined\")){_context9.next=29;break;}if(!(typeof window.customVariables.offlineSavedFiles[file.uuid]!==\"undefined\")){_context9.next=27;break;}return _context9.abrupt(\"return\",this.spawnToast(language.get(this.state.lang,\"fileAlreadyStoredOffline\",true,[\"__NAME__\"],[file.name])));case 27:makeOffline=true;fileName=file.uuid;case 29:this.getDownloadDir(makeOffline,fileName,/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee8(err,dirObj){var addToState,removeFromState,setProgress,setLoaded,chunksDonePlus,chunksWrittenPlus,downloadInterval;return _regeneratorRuntime.wrap(function _callee8$(_context8){while(1){switch(_context8.prev=_context8.next){case 0:if(!err){_context8.next=3;break;}console.log(err);return _context8.abrupt(\"return\",_this3.spawnToast(language.get(_this3.state.lang,\"couldNotGetDownloadDir\")));case 3:addToState=function addToState(){var currentDownloads=_this3.state.downloads;currentDownloads[uuid]={uuid:uuid,size:size,chunks:file.chunks,name:file.name,mime:file.mime,chunksDone:0,nextWriteChunk:0,chunksWritten:0,loaded:0,progress:0,makeOffline:file.makeOffline};window.customVariables.downloads[uuid]={uuid:uuid,size:size,chunks:file.chunks,name:file.name,mime:file.mime,chunksDone:0,nextWriteChunk:0,chunksWritten:0,loaded:0,progress:0,makeOffline:file.makeOffline};return _this3.setState({downloads:currentDownloads,downloadsCount:_this3.state.downloadsCount+1});};removeFromState=function removeFromState(){var currentDownloads=_this3.state.downloads;delete currentDownloads[uuid];delete window.customVariables.downloads[uuid];return _this3.setState({downloads:currentDownloads,downloadsCount:_this3.state.downloadsCount-1});};setProgress=function setProgress(progress){try{var currentDownloads=_this3.state.downloads;currentDownloads[uuid].progress=progress;window.customVariables.downloads[uuid].progress=progress;return _this3.setState({downloads:currentDownloads},function(){_this3.forceUpdate();});}catch(e){return console.log(e);}};setLoaded=function setLoaded(moreLoaded){try{var currentDownloads=_this3.state.downloads;currentDownloads[uuid].loaded+=moreLoaded;window.customVariables.downloads[uuid].loaded+=moreLoaded;return _this3.setState({downloads:currentDownloads});}catch(e){return console.log(e);}};chunksDonePlus=function chunksDonePlus(){try{var currentDownloads=_this3.state.downloads;currentDownloads[uuid].chunksDone+=1;window.customVariables.downloads[uuid].chunksDone+=1;return _this3.setState({downloads:currentDownloads});}catch(e){return console.log(e);}};chunksWrittenPlus=function chunksWrittenPlus(){try{var currentDownloads=_this3.state.downloads;currentDownloads[uuid].nextWriteChunk+=1;window.customVariables.downloads[uuid].nextWriteChunk+=1;currentDownloads[uuid].chunksWritten+=1;window.customVariables.downloads[uuid].chunksWritten+=1;return _this3.setState({downloads:currentDownloads});}catch(e){return console.log(e);}};addToState();_this3.spawnToast(language.get(_this3.state.lang,\"fileDownloadStarted\",true,[\"__NAME__\"],[file.name]));_context8.next=13;return window.customVariables.downloadSemaphore.acquire();case 13:downloadInterval=setInterval(function(){currentIndex+=1;var thisIndex=currentIndex;if(thisIndex<file.chunks&&typeof window.customVariables.downloads[uuid]!==\"undefined\"){_this3.downloadFileChunk(file,thisIndex,0,10,/*#__PURE__*/function(){var _ref3=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee7(err,downloadIndex,downloadData){return _regeneratorRuntime.wrap(function _callee7$(_context7){while(1){switch(_context7.prev=_context7.next){case 0:if(!err){_context7.next=22;break;}console.log(err);window.customVariables.downloadSemaphore.release();removeFromState();if(!(err==\"stopped\")){_context7.next=21;break;}if(!(typeof window.customVariables.stoppedDownloadsDone[uuid]==\"undefined\")){_context7.next=18;break;}window.customVariables.stoppedDownloadsDone[uuid]=true;_context7.prev=7;_context7.next=10;return Plugins.Filesystem.deleteFile({path:dirObj.path+\"/\"+file.name,directory:dirObj.directory});case 10:_context7.next=15;break;case 12:_context7.prev=12;_context7.t0=_context7[\"catch\"](7);console.log(_context7.t0);case 15:return _context7.abrupt(\"return\",_this3.spawnToast(language.get(_this3.state.lang,\"downloadStopped\",true,[\"__NAME__\"],[file.name])));case 18:return _context7.abrupt(\"return\",false);case 19:_context7.next=22;break;case 21:return _context7.abrupt(\"return\",_this3.spawnToast(language.get(_this3.state.lang,\"fileDownloadError\",true,[\"__NAME__\"],[file.name])));case 22:if(typeof window.customVariables.downloads[uuid]!==\"undefined\"){chunksDonePlus();setLoaded(downloadData.length);_this3.writeChunkToFile(file,dirObj,uuid,downloadIndex,downloadData,/*#__PURE__*/function(){var _ref4=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee6(err){var progress,items,windowItems,i,_i;return _regeneratorRuntime.wrap(function _callee6$(_context6){while(1){switch(_context6.prev=_context6.next){case 0:if(!err){_context6.next=5;break;}console.log(err);window.customVariables.downloadSemaphore.release();removeFromState();return _context6.abrupt(\"return\",_this3.spawnToast(language.get(_this3.state.lang,\"fileWriteError\",true,[\"__NAME__\"],[file.name])));case 5:chunksWrittenPlus();try{progress=(window.customVariables.downloads[uuid].loaded/window.customVariables.downloads[uuid].size*100).toFixed(2);if(progress>=100){progress=100;}setProgress(progress);}catch(e){console.log(e);}_context6.prev=7;if(!(window.customVariables.downloads[uuid].chunksWritten>=window.customVariables.downloads[uuid].chunks)){_context6.next=28;break;}if(!(typeof window.customVariables.downloads[uuid].makeOffline!==\"undefined\")){_context6.next=25;break;}window.customVariables.offlineSavedFiles[file.uuid]=true;items=_this3.state.itemList;windowItems=window.customVariables.itemList;for(i=0;i<items.length;i++){if(items[i].uuid==file.uuid){items[i].offline=true;}}for(_i=0;_i<windowItems.length;_i++){if(windowItems[_i].uuid==file.uuid){windowItems[_i].offline=true;}}_this3.setState({itemList:items});window.customVariables.itemList=windowItems;if(typeof window.customVariables.cachedFiles[uuid]!==\"undefined\"){window.customVariables.cachedFiles[uuid].offline=true;}_this3.spawnToast(language.get(_this3.state.lang,\"fileIsNowAvailableOffline\",true,[\"__NAME__\"],[file.name]));removeFromState();window.customFunctions.saveOfflineSavedFiles();window.customVariables.downloadSemaphore.release();return _context6.abrupt(\"return\",_this3.forceUpdate());case 25:_this3.spawnToast(language.get(_this3.state.lang,\"fileDownloadDone\",true,[\"__NAME__\"],[file.name]));window.customVariables.downloadSemaphore.release();return _context6.abrupt(\"return\",removeFromState());case 28:_context6.next=33;break;case 30:_context6.prev=30;_context6.t0=_context6[\"catch\"](7);console.log(_context6.t0);case 33:case\"end\":return _context6.stop();}}},_callee6,null,[[7,30]]);}));return function(_x30){return _ref4.apply(this,arguments);};}());}case 23:case\"end\":return _context7.stop();}}},_callee7,null,[[7,12]]);}));return function(_x27,_x28,_x29){return _ref3.apply(this,arguments);};}());}else{clearInterval(downloadInterval);}},100);case 14:case\"end\":return _context8.stop();}}},_callee8);}));return function(_x25,_x26){return _ref2.apply(this,arguments);};}());case 30:case\"end\":return _context9.stop();}}},_callee9,this);}));return _queueFileDownload.apply(this,arguments);}export function getThumbnail(_x18,_x19,_x20){return _getThumbnail.apply(this,arguments);}function _getThumbnail(){_getThumbnail=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee15(file,thumbURL,ext){var _this4=this;return _regeneratorRuntime.wrap(function _callee15$(_context15){while(1){switch(_context15.prev=_context15.next){case 0:return _context15.abrupt(\"return\",new Promise(/*#__PURE__*/function(){var _ref5=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee14(resolve,reject){var networkStatus,dirObj,videoExts,thumbnailFileName,nameEx,writeThumbnail,uri,imageURL;return _regeneratorRuntime.wrap(function _callee14$(_context14){while(1){switch(_context14.prev=_context14.next){case 0:if(!Capacitor.isNative){_context14.next=10;break;}if(!_this4.state.settings.onlyWifi){_context14.next=8;break;}_context14.next=4;return Plugins.Network.getStatus();case 4:networkStatus=_context14.sent;if(!(networkStatus.connectionType!==\"wifi\")){_context14.next=8;break;}reject(\"only wifi\");return _context14.abrupt(\"return\",_this4.spawnToast(language.get(_this4.state.lang,\"onlyWifiError\")));case 8:_context14.next=11;break;case 10:return _context14.abrupt(\"return\",reject(\"not native\"));case 11:dirObj={path:\"ThumbnailCache/\"+file.uuid,directory:FilesystemDirectory.External};videoExts=[\"mp4\",\"webm\",\"mov\",\"avi\",\"wmv\"];_context14.next=15;return window.customVariables.thumbnailSemaphore.acquire();case 15:if(!(file.chunks>16&&!videoExts.includes(ext))){_context14.next=18;break;}window.customVariables.thumbnailSemaphore.release();return _context14.abrupt(\"return\",reject(\"too big\"));case 18:thumbnailFileName=file.name;if(videoExts.includes(ext)){nameEx=file.name.split(\".\");nameEx[nameEx.length-1]=\"jpg\";thumbnailFileName=nameEx.join(\".\");}if(!(typeof window.customVariables.thumbnailCache[file.uuid]==\"undefined\")){_context14.next=28;break;}if(!(thumbURL!==window.location.href)){_context14.next=24;break;}window.customVariables.thumbnailSemaphore.release();return _context14.abrupt(\"return\",reject(\"url changed\"));case 24:writeThumbnail=/*#__PURE__*/function(){var _ref6=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee11(arrayBuffer){return _regeneratorRuntime.wrap(function _callee11$(_context11){while(1){switch(_context11.prev=_context11.next){case 0:workers.convertArrayBufferToBase64(arrayBuffer,/*#__PURE__*/function(){var _ref7=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee10(b64Data){var uri,imageURL;return _regeneratorRuntime.wrap(function _callee10$(_context10){while(1){switch(_context10.prev=_context10.next){case 0:_context10.prev=0;_context10.next=3;return Plugins.Filesystem.writeFile({path:dirObj.path+\"/\"+thumbnailFileName,directory:dirObj.directory,data:b64Data,recursive:true});case 3:_context10.next=5;return Plugins.Filesystem.getUri({path:dirObj.path+\"/\"+thumbnailFileName,directory:dirObj.directory});case 5:uri=_context10.sent;_context10.next=12;break;case 8:_context10.prev=8;_context10.t0=_context10[\"catch\"](0);window.customVariables.thumbnailSemaphore.release();return _context10.abrupt(\"return\",reject(_context10.t0));case 12:if(!(thumbURL!==window.location.href)){_context10.next=15;break;}window.customVariables.thumbnailSemaphore.release();return _context10.abrupt(\"return\",reject(\"url changed\"));case 15:imageURL=window.Ionic.WebView.convertFileSrc(uri.uri);window.customVariables.thumbnailBlobCache[file.uuid]=imageURL;window.customVariables.thumbnailCache[file.uuid]=true;window.customVariables.thumbnailSemaphore.release();return _context10.abrupt(\"return\",resolve(imageURL));case 20:case\"end\":return _context10.stop();}}},_callee10,null,[[0,8]]);}));return function(_x34){return _ref7.apply(this,arguments);};}());case 1:case\"end\":return _context11.stop();}}},_callee11);}));return function writeThumbnail(_x33){return _ref6.apply(this,arguments);};}();if(videoExts.includes(ext)){_this4.downloadPreview(file,undefined,/*#__PURE__*/function(){var _ref8=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee12(err,downloadData){var thumbnailData,compressedImage,fileReader;return _regeneratorRuntime.wrap(function _callee12$(_context12){while(1){switch(_context12.prev=_context12.next){case 0:if(!err){_context12.next=3;break;}window.customVariables.thumbnailSemaphore.release();return _context12.abrupt(\"return\",reject(err));case 3:downloadData=new File([new Blob([downloadData],{type:file.mime})],file.name,{lastModified:new Date(),type:file.mime});_context12.prev=4;_context12.next=7;return utils.getVideoCover(downloadData);case 7:thumbnailData=_context12.sent;_context12.next=14;break;case 10:_context12.prev=10;_context12.t0=_context12[\"catch\"](4);window.customVariables.thumbnailSemaphore.release();return _context12.abrupt(\"return\",reject(_context12.t0));case 14:thumbnailData=new File([thumbnailData],thumbnailFileName,{lastModified:new Date(),type:\"image/jpeg\"});_context12.prev=15;_context12.next=18;return imageCompression(thumbnailData,{maxWidthOrHeight:200,useWebWorker:true});case 18:compressedImage=_context12.sent;_context12.next=25;break;case 21:_context12.prev=21;_context12.t1=_context12[\"catch\"](15);window.customVariables.thumbnailSemaphore.release();return _context12.abrupt(\"return\",reject(_context12.t1));case 25:fileReader=new FileReader();fileReader.onload=function(e){var arrayBuffer=e.target.result;return writeThumbnail(arrayBuffer);};fileReader.onerror=function(err){window.customVariables.thumbnailSemaphore.release();return reject(err);};fileReader.readAsArrayBuffer(compressedImage);case 29:case\"end\":return _context12.stop();}}},_callee12,null,[[4,10],[15,21]]);}));return function(_x35,_x36){return _ref8.apply(this,arguments);};}(),3);}else{_this4.downloadPreview(file,undefined,/*#__PURE__*/function(){var _ref9=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee13(err,data){var compressedImage,fileReader;return _regeneratorRuntime.wrap(function _callee13$(_context13){while(1){switch(_context13.prev=_context13.next){case 0:if(!err){_context13.next=3;break;}window.customVariables.thumbnailSemaphore.release();return _context13.abrupt(\"return\",reject(err));case 3:if(!utils.canCompressThumbnail(ext)){_context13.next=21;break;}data=new File([new Blob([data],{type:file.mime})],thumbnailFileName,{lastModified:new Date(),type:file.mime});_context13.prev=5;_context13.next=8;return imageCompression(data,{maxWidthOrHeight:200,useWebWorker:true});case 8:compressedImage=_context13.sent;_context13.next=15;break;case 11:_context13.prev=11;_context13.t0=_context13[\"catch\"](5);window.customVariables.thumbnailSemaphore.release();return _context13.abrupt(\"return\",reject(_context13.t0));case 15:fileReader=new FileReader();fileReader.onload=function(e){var arrayBuffer=e.target.result;return writeThumbnail(arrayBuffer);};fileReader.onerror=function(err){window.customVariables.thumbnailSemaphore.release();return reject(err);};fileReader.readAsArrayBuffer(compressedImage);_context13.next=22;break;case 21:return _context13.abrupt(\"return\",writeThumbnail(data));case 22:case\"end\":return _context13.stop();}}},_callee13,null,[[5,11]]);}));return function(_x37,_x38){return _ref9.apply(this,arguments);};}());}_context14.next=47;break;case 28:_context14.prev=28;_context14.next=31;return Plugins.Filesystem.getUri({path:dirObj.path+\"/\"+thumbnailFileName,directory:dirObj.directory});case 31:uri=_context14.sent;_context14.next=39;break;case 34:_context14.prev=34;_context14.t0=_context14[\"catch\"](28);window.customVariables.thumbnailSemaphore.release();delete window.customVariables.thumbnailCache[file.uuid];return _context14.abrupt(\"return\",reject(_context14.t0));case 39:if(!(thumbURL!==window.location.href)){_context14.next=42;break;}window.customVariables.thumbnailSemaphore.release();return _context14.abrupt(\"return\",reject(\"url changed\"));case 42:imageURL=window.Ionic.WebView.convertFileSrc(uri.uri);window.customVariables.thumbnailBlobCache[file.uuid]=imageURL;window.customVariables.thumbnailCache[file.uuid]=true;window.customVariables.thumbnailSemaphore.release();return _context14.abrupt(\"return\",resolve(imageURL));case 47:case\"end\":return _context14.stop();}}},_callee14,null,[[28,34]]);}));return function(_x31,_x32){return _ref5.apply(this,arguments);};}()));case 1:case\"end\":return _context15.stop();}}},_callee15);}));return _getThumbnail.apply(this,arguments);}export function downloadPreview(_x21,_x22,_x23){return _downloadPreview.apply(this,arguments);}function _downloadPreview(){_downloadPreview=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee16(file,progressCallback,callback){var _this5=this;var maxChunks,dataArray,currentIndex,currentWriteIndex,chunksDone,write,downloadInterval,_args16=arguments;return _regeneratorRuntime.wrap(function _callee16$(_context16){while(1){switch(_context16.prev=_context16.next){case 0:maxChunks=_args16.length>3&&_args16[3]!==undefined?_args16[3]:Infinity;dataArray=[];currentIndex=-1;currentWriteIndex=0;chunksDone=0;write=function write(index,data,callback){if(currentWriteIndex==index){dataArray.push(data);currentWriteIndex+=1;chunksDone+=1;if(typeof progressCallback==\"function\"){progressCallback(chunksDone);}if(chunksDone==file.chunks||chunksDone==maxChunks){return callback(null,utils.uInt8ArrayConcat(dataArray));}}else{return setTimeout(function(){write(index,data,callback);},50);}};downloadInterval=setInterval(function(){currentIndex+=1;var thisIndex=currentIndex;if(thisIndex<file.chunks&&thisIndex<maxChunks&&!window.customVariables.stopGettingPreviewData){_this5.downloadFileChunk(file,thisIndex,0,32,function(err,downloadIndex,downloadData){if(err){return callback(err);}write(downloadIndex,downloadData,callback);});}else{if(window.customVariables.stopGettingPreviewData){window.customVariables.isGettingPreviewData=false;callback(\"stopped\");}clearInterval(downloadInterval);}},100);case 7:case\"end\":return _context16.stop();}}},_callee16);}));return _downloadPreview.apply(this,arguments);}","map":{"version":3,"sources":["/Users/jan/Documents/filen/app/src/components/download.js"],"names":["language","workers","Capacitor","FilesystemDirectory","Plugins","imageCompression","call","utils","require","getThumbnailDir","uuid","callback","platform","path","directory","External","Filesystem","mkdir","recursive","getUri","uri","message","Documents","Error","getDownloadDir","makeOffline","fileName","ExternalStorage","downloadFileChunk","file","index","tries","maxTries","chunks","window","customVariables","stoppedDownloads","downloadChunkSemaphore","acquire","fetchWithTimeout","fetch","getDownloadServer","region","bucket","method","then","response","arrayBuffer","res","byteLength","decryptData","key","decrypted","release","setTimeout","e","console","log","catch","err","writeChunkToFile","dirObj","data","downloads","nextWriteChunk","deleteFile","name","convertArrayBufferToBase64","b64Data","writeFile","appendFile","queueFileDownload","isNative","state","settings","onlyWifi","Network","getStatus","networkStatus","connectionType","spawnToast","get","lang","prop","size","currentIndex","ext","split","length","toLowerCase","undefined","stoppedDownloadsDone","offlineSavedFiles","addToState","currentDownloads","mime","chunksDone","chunksWritten","loaded","progress","setState","downloadsCount","removeFromState","setProgress","forceUpdate","setLoaded","moreLoaded","chunksDonePlus","chunksWrittenPlus","downloadSemaphore","downloadInterval","setInterval","thisIndex","downloadIndex","downloadData","toFixed","items","itemList","windowItems","i","offline","cachedFiles","customFunctions","saveOfflineSavedFiles","clearInterval","getThumbnail","thumbURL","Promise","resolve","reject","videoExts","thumbnailSemaphore","includes","thumbnailFileName","nameEx","join","thumbnailCache","location","href","writeThumbnail","imageURL","Ionic","WebView","convertFileSrc","thumbnailBlobCache","downloadPreview","File","Blob","type","lastModified","Date","getVideoCover","thumbnailData","maxWidthOrHeight","useWebWorker","compressedImage","fileReader","FileReader","onload","target","result","onerror","readAsArrayBuffer","canCompressThumbnail","progressCallback","maxChunks","Infinity","dataArray","currentWriteIndex","write","push","uInt8ArrayConcat","stopGettingPreviewData","isGettingPreviewData"],"mappings":"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","sourcesContent":["import * as language from \"../utils/language\"\r\nimport * as workers from \"../utils/workers\"\r\nimport { Capacitor, FilesystemDirectory, Plugins } from \"@capacitor/core\"\r\nimport imageCompression from 'browser-image-compression';\r\nimport { call } from \"ionicons/icons\";\r\n\r\nconst utils = require(\"../utils/utils\")\r\n\r\nexport async function getThumbnailDir(uuid, callback){\r\n    if(Capacitor.platform == \"android\"){\r\n        let path = \"ThumbnailCache/\" + uuid\r\n        let directory = FilesystemDirectory.External\r\n\r\n        try{\r\n            await Plugins.Filesystem.mkdir({\r\n                path,\r\n                directory,\r\n                recursive: true \r\n            })\r\n\r\n            var uri = await Plugins.Filesystem.getUri({\r\n                path,\r\n                directory\r\n            })\r\n\r\n            return callback(null, {\r\n                path,\r\n                directory,\r\n                uri\r\n            })\r\n        }\r\n        catch(e){\r\n            if(e.message == \"Directory exists\"){\r\n                try{\r\n                    var uri = await Plugins.Filesystem.getUri({\r\n                        path,\r\n                        directory\r\n                    })\r\n\r\n                    return callback(null, {\r\n                        path,\r\n                        directory,\r\n                        uri\r\n                    })\r\n                }\r\n                catch(e){\r\n                    return callback(e)\r\n                }\r\n            }\r\n            else{\r\n                return callback(e)\r\n            }\r\n        }\r\n    }\r\n    else if(Capacitor.platform == \"ios\"){\r\n        let path = \"FilenThumbnailCache/\" + uuid\r\n        let directory = FilesystemDirectory.Documents\r\n\r\n        try{\r\n            await Plugins.Filesystem.mkdir({\r\n                path,\r\n                directory,\r\n                recursive: true \r\n            })\r\n\r\n            var uri = await Plugins.Filesystem.getUri({\r\n                path,\r\n                directory\r\n            })\r\n\r\n            return callback(null, {\r\n                path,\r\n                directory,\r\n                uri\r\n            })\r\n        }\r\n        catch(e){\r\n            if(e.message == \"Directory exists\"){\r\n                try{\r\n                    var uri = await Plugins.Filesystem.getUri({\r\n                        path,\r\n                        directory\r\n                    })\r\n\r\n                    return callback(null, {\r\n                        path,\r\n                        directory,\r\n                        uri\r\n                    })\r\n                }\r\n                catch(e){\r\n                    return callback(e)\r\n                }\r\n            }\r\n            else{\r\n                return callback(e)\r\n            }\r\n        }\r\n    }\r\n    else{\r\n        return callback(new Error(\"Can only run getdir function on native ios or android device\"))\r\n    }\r\n}\r\n\r\nexport async function getDownloadDir(makeOffline, fileName, callback){\r\n    if(Capacitor.platform == \"android\"){\r\n        if(makeOffline){\r\n            let path = \"OfflineFiles/\" + fileName\r\n            let directory = FilesystemDirectory.External\r\n\r\n            try{\r\n                await Plugins.Filesystem.mkdir({\r\n                    path,\r\n                    directory,\r\n                    recursive: true \r\n                })\r\n\r\n                var uri = await Plugins.Filesystem.getUri({\r\n                    path,\r\n                    directory\r\n                })\r\n\r\n                return callback(null, {\r\n                    path,\r\n                    directory,\r\n                    uri\r\n                })\r\n            }\r\n            catch(e){\r\n                if(e.message == \"Directory exists\"){\r\n                    try{\r\n                        var uri = await Plugins.Filesystem.getUri({\r\n                            path,\r\n                            directory\r\n                        })\r\n\r\n                        return callback(null, {\r\n                            path,\r\n                            directory,\r\n                            uri\r\n                        })\r\n                    }\r\n                    catch(e){\r\n                        return callback(e)\r\n                    }\r\n                }\r\n                else{\r\n                    return callback(e)\r\n                }\r\n            }\r\n        }\r\n        else{\r\n            let path = \"Download\"\r\n            let directory = FilesystemDirectory.ExternalStorage\r\n\r\n            try{\r\n                await Plugins.Filesystem.mkdir({\r\n                    path,\r\n                    directory,\r\n                    recursive: true \r\n                })\r\n\r\n                var uri = await Plugins.Filesystem.getUri({\r\n                    path,\r\n                    directory\r\n                })\r\n\r\n                return callback(null, {\r\n                    path,\r\n                    directory,\r\n                    uri\r\n                })\r\n            }\r\n            catch(e){\r\n                if(e.message == \"Directory exists\"){\r\n                    try{\r\n                        var uri = await Plugins.Filesystem.getUri({\r\n                            path,\r\n                            directory\r\n                        })\r\n\r\n                        return callback(null, {\r\n                            path,\r\n                            directory,\r\n                            uri\r\n                        })\r\n                    }\r\n                    catch(e){\r\n                        return callback(e)\r\n                    }\r\n                }\r\n                else{\r\n                    path = \"Downloads\"\r\n                    directory = FilesystemDirectory.External\r\n                    \r\n                    try{\r\n                        await Plugins.Filesystem.mkdir({\r\n                            path,\r\n                            directory,\r\n                            recursive: true \r\n                        })\r\n\r\n                        var uri = await Plugins.Filesystem.getUri({\r\n                            path,\r\n                            directory\r\n                        })\r\n\r\n                        return callback(null, {\r\n                            path,\r\n                            directory,\r\n                            uri\r\n                        })\r\n                    }\r\n                    catch(e){\r\n                        if(e.message == \"Directory exists\"){\r\n                            try{\r\n                                var uri = await Plugins.Filesystem.getUri({\r\n                                    path,\r\n                                    directory\r\n                                })\r\n\r\n                                return callback(null, {\r\n                                    path,\r\n                                    directory,\r\n                                    uri\r\n                                })\r\n                            }\r\n                            catch(e){\r\n                                return callback(e)\r\n                            }\r\n                        }\r\n                        else{\r\n                            return callback(e)\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n    else if(Capacitor.platform == \"ios\"){\r\n        if(makeOffline){\r\n            let path = \"FilenOfflineFiles/\" + fileName\r\n            let directory = FilesystemDirectory.Documents\r\n\r\n            try{\r\n                await Plugins.Filesystem.mkdir({\r\n                    path,\r\n                    directory,\r\n                    recursive: true \r\n                })\r\n\r\n                var uri = await Plugins.Filesystem.getUri({\r\n                    path,\r\n                    directory\r\n                })\r\n\r\n                return callback(null, {\r\n                    path,\r\n                    directory,\r\n                    uri\r\n                })\r\n            }\r\n            catch(e){\r\n                if(e.message == \"Directory exists\"){\r\n                    try{\r\n                        var uri = await Plugins.Filesystem.getUri({\r\n                            path,\r\n                            directory\r\n                        })\r\n\r\n                        return callback(null, {\r\n                            path,\r\n                            directory,\r\n                            uri\r\n                        })\r\n                    }\r\n                    catch(e){\r\n                        return callback(e)\r\n                    }\r\n                }\r\n                else{\r\n                    return callback(e)\r\n                }\r\n            }\r\n        }\r\n        else{\r\n            let path = \"Filen Downloads\"\r\n            let directory = FilesystemDirectory.ExternalStorage\r\n\r\n            try{\r\n                await Plugins.Filesystem.mkdir({\r\n                    path,\r\n                    directory,\r\n                    recursive: true \r\n                })\r\n\r\n                var uri = await Plugins.Filesystem.getUri({\r\n                    path,\r\n                    directory\r\n                })\r\n\r\n                return callback(null, {\r\n                    path,\r\n                    directory,\r\n                    uri\r\n                })\r\n            }\r\n            catch(e){\r\n                if(e.message == \"Directory exists\"){\r\n                    try{\r\n                        var uri = await Plugins.Filesystem.getUri({\r\n                            path,\r\n                            directory\r\n                        })\r\n\r\n                        return callback(null, {\r\n                            path,\r\n                            directory,\r\n                            uri\r\n                        })\r\n                    }\r\n                    catch(e){\r\n                        return callback(e)\r\n                    }\r\n                }\r\n                else{\r\n                    return callback(e)\r\n                }\r\n            }\r\n        }\r\n    }\r\n    else{\r\n        return callback(new Error(\"Can only run getdir function on native ios or android device\"))\r\n    }\r\n}\r\n\r\nexport async function downloadFileChunk(file, index, tries, maxTries, callback){\r\n    if(tries >= maxTries){\r\n\t\treturn callback(new Error(\"Max download retries reached for \" + file.uuid + \", returning.\"))\r\n\t}\r\n\r\n\tif(index >= file.chunks){\r\n\t\treturn callback(null, index)\r\n    }\r\n\r\n    if(typeof window.customVariables.stoppedDownloads[file.uuid] !== \"undefined\"){\r\n        return callback(\"stopped\")\r\n    }\r\n\r\n    await window.customVariables.downloadChunkSemaphore.acquire()\r\n\r\n    utils.fetchWithTimeout(3600000, fetch(utils.getDownloadServer() + \"/\" + file.region + \"/\" + file.bucket + \"/\" + file.uuid + \"/\" + index, {\r\n        method: \"GET\"\r\n    })).then((response) => {\r\n        response.arrayBuffer().then((res) => {\r\n            if(typeof window.customVariables.stoppedDownloads[file.uuid] !== \"undefined\"){\r\n                return callback(\"stopped\")\r\n            }\r\n\r\n            try{\r\n                if(res.byteLength){\r\n                    if(res.byteLength > 1){\r\n                        workers.decryptData(file.uuid, index, file.key, res, (decrypted) => {\r\n                            window.customVariables.downloadChunkSemaphore.release()\r\n    \r\n                            return callback(null, index, decrypted)\r\n                        })\r\n                    }\r\n                    else{\r\n                        window.customVariables.downloadChunkSemaphore.release()\r\n\r\n                        return setTimeout(() => {\r\n                            this.downloadFileChunk(file, index, (tries + 1), maxTries, callback)\r\n                        }, 1000)\r\n                    }\r\n                }\r\n                else{\r\n                    window.customVariables.downloadChunkSemaphore.release()\r\n\r\n                    return setTimeout(() => {\r\n                        this.downloadFileChunk(file, index, (tries + 1), maxTries, callback)\r\n                    }, 1000)\r\n                }\r\n            }\r\n            catch(e){\r\n                console.log(e)\r\n\r\n                window.customVariables.downloadChunkSemaphore.release()\r\n\r\n                return setTimeout(() => {\r\n                    this.downloadFileChunk(file, index, (tries + 1), maxTries, callback)\r\n                }, 1000)\r\n            }\r\n        }).catch((err) => {\r\n            console.log(err)\r\n\r\n            window.customVariables.downloadChunkSemaphore.release()\r\n\r\n            return setTimeout(() => {\r\n                this.downloadFileChunk(file, index, (tries + 1), maxTries, callback)\r\n            }, 1000)\r\n        })\r\n    }).catch((err) => {\r\n        console.log(err)\r\n\r\n        window.customVariables.downloadChunkSemaphore.release()\r\n\r\n        return setTimeout(() => {\r\n            this.downloadFileChunk(file, index, (tries + 1), maxTries, callback)\r\n        }, 1000)\r\n    })\r\n}\r\n\r\nexport async function writeChunkToFile(file, dirObj, uuid, index, data, callback){\r\n    if(!window.customVariables.downloads[uuid]){\r\n        return callback(new Error(\"Download does not exist\"))\r\n    }\r\n\r\n    if(window.customVariables.downloads[uuid].nextWriteChunk !== index){\r\n        return setTimeout(() => {\r\n            this.writeChunkToFile(file, dirObj, uuid, index, data, callback)\r\n        }, 50)\r\n    }\r\n\r\n    if(index == 0){\r\n        try{\r\n            await Plugins.Filesystem.deleteFile({\r\n                path: dirObj.path + \"/\" + file.name,\r\n                directory: dirObj.directory\r\n            })\r\n        }\r\n        catch(e){\r\n            console.log(e)\r\n        }\r\n    }\r\n\r\n    workers.convertArrayBufferToBase64(data, async (b64Data) => {\r\n        if(index == 0){\r\n            try{\r\n                await Plugins.Filesystem.writeFile({\r\n                    path: dirObj.path + \"/\" + file.name,\r\n                    directory: dirObj.directory,\r\n                    data: b64Data,\r\n                    recursive: true\r\n                })\r\n    \r\n                return callback(null)\r\n            }\r\n            catch(e){\r\n                return callback(e)\r\n            }\r\n        }\r\n        else{\r\n            try{\r\n                await Plugins.Filesystem.appendFile({\r\n                    path: dirObj.path + \"/\" + file.name,\r\n                    directory: dirObj.directory,\r\n                    data: b64Data\r\n                })\r\n    \r\n                return callback(null)\r\n            }\r\n            catch(e){\r\n                return callback(e)\r\n            }\r\n        }\r\n    })\r\n}\r\n\r\nexport async function queueFileDownload(file){\r\n    if(Capacitor.isNative){\r\n        if(this.state.settings.onlyWifi){\r\n            let networkStatus = await Plugins.Network.getStatus()\r\n\r\n            if(networkStatus.connectionType !== \"wifi\"){\r\n                return this.spawnToast(language.get(this.state.lang, \"onlyWifiError\"))\r\n            }\r\n        }\r\n    }\r\n\r\n    for(let prop in window.customVariables.downloads){\r\n\t\tif(window.customVariables.downloads[prop].name == file.name){\r\n\t\t\treturn this.spawnToast(language.get(this.state.lang, \"fileDownloadAlreadyDownloadingFile\", true, [\"__NAME__\"], [file.name]))\r\n\t\t}\r\n    }\r\n    \r\n    let uuid = file.uuid\r\n\tlet name = file.name\r\n\tlet size = file.size\r\n\tlet currentIndex = -1\r\n\r\n\tlet ext = file.name.split(\".\")\r\n\text = ext[ext.length - 1].toLowerCase()\r\n\r\n    let makeOffline = false\r\n    let fileName = file.name\r\n\r\n    window.customVariables.stoppedDownloads[uuid] = undefined\r\n    window.customVariables.stoppedDownloadsDone[uuid] = undefined\r\n\r\n\tif(typeof file.makeOffline !== \"undefined\"){\r\n        if(typeof window.customVariables.offlineSavedFiles[file.uuid] !== \"undefined\"){\r\n            return this.spawnToast(language.get(this.state.lang, \"fileAlreadyStoredOffline\", true, [\"__NAME__\"], [file.name]))\r\n        }\r\n\r\n        makeOffline = true\r\n        fileName = file.uuid\r\n    }\r\n\r\n    this.getDownloadDir(makeOffline, fileName, async (err, dirObj) => {\r\n        if(err){\r\n            console.log(err)\r\n\r\n            return this.spawnToast(language.get(this.state.lang, \"couldNotGetDownloadDir\"))\r\n        }\r\n\r\n        const addToState = () => {\r\n\t\t\tlet currentDownloads = this.state.downloads\r\n\r\n\t\t\tcurrentDownloads[uuid] = {\r\n\t\t\t\tuuid,\r\n\t\t\t\tsize,\r\n                chunks: file.chunks,\r\n                name: file.name,\r\n                mime: file.mime,\r\n                chunksDone: 0,\r\n                nextWriteChunk: 0,\r\n                chunksWritten: 0,\r\n\t\t\t\tloaded: 0,\r\n                progress: 0,\r\n                makeOffline: file.makeOffline\r\n\t\t\t}\r\n\r\n\t\t\twindow.customVariables.downloads[uuid] = {\r\n\t\t\t\tuuid,\r\n\t\t\t\tsize,\r\n                chunks: file.chunks,\r\n                name: file.name,\r\n                mime: file.mime,\r\n                chunksDone: 0,\r\n                nextWriteChunk: 0,\r\n                chunksWritten: 0,\r\n\t\t\t\tloaded: 0,\r\n                progress: 0,\r\n                makeOffline: file.makeOffline\r\n\t\t\t}\r\n\r\n\t\t\treturn this.setState({\r\n\t\t\t\tdownloads: currentDownloads,\r\n\t\t\t\tdownloadsCount: (this.state.downloadsCount + 1)\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tconst removeFromState = () => {\r\n\t\t\tlet currentDownloads = this.state.downloads\r\n\r\n\t\t\tdelete currentDownloads[uuid]\r\n\t\t\tdelete window.customVariables.downloads[uuid]\r\n\r\n\t\t\treturn this.setState({\r\n\t\t\t\tdownloads: currentDownloads,\r\n\t\t\t\tdownloadsCount: (this.state.downloadsCount - 1)\r\n\t\t\t})\r\n\t\t}\r\n\r\n\t\tconst setProgress = (progress) => {\r\n\t\t\ttry{\r\n\t\t\t\tlet currentDownloads = this.state.downloads\r\n\r\n\t\t\t\tcurrentDownloads[uuid].progress = progress\r\n\t\t\t\twindow.customVariables.downloads[uuid].progress = progress\r\n\r\n\t\t\t\treturn this.setState({\r\n\t\t\t\t\tdownloads: currentDownloads\r\n\t\t\t\t}, () => {\r\n                    this.forceUpdate()\r\n                })\r\n\t\t\t}\r\n\t\t\tcatch(e){\r\n\t\t\t\treturn console.log(e)\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tconst setLoaded = (moreLoaded) => {\r\n\t\t\ttry{\r\n\t\t\t\tlet currentDownloads = this.state.downloads\r\n\r\n\t\t\t\tcurrentDownloads[uuid].loaded += moreLoaded\r\n\t\t\t\twindow.customVariables.downloads[uuid].loaded += moreLoaded\r\n\r\n\t\t\t\treturn this.setState({\r\n\t\t\t\t\tdownloads: currentDownloads\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tcatch(e){\r\n\t\t\t\treturn console.log(e)\r\n\t\t\t}\r\n        }\r\n        \r\n        const chunksDonePlus = () => {\r\n            try{\r\n\t\t\t\tlet currentDownloads = this.state.downloads\r\n\r\n\t\t\t\tcurrentDownloads[uuid].chunksDone += 1\r\n\t\t\t\twindow.customVariables.downloads[uuid].chunksDone += 1\r\n\r\n\t\t\t\treturn this.setState({\r\n\t\t\t\t\tdownloads: currentDownloads\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tcatch(e){\r\n\t\t\t\treturn console.log(e)\r\n\t\t\t}\r\n        }\r\n\r\n        const chunksWrittenPlus = () => {\r\n            try{\r\n\t\t\t\tlet currentDownloads = this.state.downloads\r\n\r\n\t\t\t\tcurrentDownloads[uuid].nextWriteChunk += 1\r\n                window.customVariables.downloads[uuid].nextWriteChunk += 1\r\n                currentDownloads[uuid].chunksWritten += 1\r\n\t\t\t\twindow.customVariables.downloads[uuid].chunksWritten += 1\r\n\r\n\t\t\t\treturn this.setState({\r\n\t\t\t\t\tdownloads: currentDownloads\r\n\t\t\t\t})\r\n\t\t\t}\r\n\t\t\tcatch(e){\r\n\t\t\t\treturn console.log(e)\r\n\t\t\t}\r\n        }\r\n\r\n\t\taddToState()\r\n\r\n        this.spawnToast(language.get(this.state.lang, \"fileDownloadStarted\", true, [\"__NAME__\"], [file.name]))\r\n\r\n        await window.customVariables.downloadSemaphore.acquire()\r\n        \r\n        let downloadInterval = setInterval(() => {\r\n            currentIndex += 1\r\n\r\n            let thisIndex = currentIndex\r\n\r\n            if(thisIndex < file.chunks && typeof window.customVariables.downloads[uuid] !== \"undefined\"){\r\n                this.downloadFileChunk(file, thisIndex, 0, 10, async (err, downloadIndex, downloadData) => {\r\n                    if(err){\r\n                        console.log(err)\r\n\r\n                        window.customVariables.downloadSemaphore.release()\r\n\r\n                        removeFromState()\r\n\r\n                        if(err == \"stopped\"){\r\n                            if(typeof window.customVariables.stoppedDownloadsDone[uuid] == \"undefined\"){\r\n                                window.customVariables.stoppedDownloadsDone[uuid] = true\r\n\r\n                                try{\r\n                                    await Plugins.Filesystem.deleteFile({\r\n                                        path: dirObj.path + \"/\" + file.name,\r\n                                        directory: dirObj.directory\r\n                                    })\r\n                                }\r\n                                catch(e){\r\n                                    console.log(e)\r\n                                }\r\n\r\n                                return this.spawnToast(language.get(this.state.lang, \"downloadStopped\", true, [\"__NAME__\"], [file.name]))\r\n                            }\r\n                            else{\r\n                                return false\r\n                            }\r\n                        }\r\n                        else{\r\n                            return this.spawnToast(language.get(this.state.lang, \"fileDownloadError\", true, [\"__NAME__\"], [file.name]))\r\n                        }\r\n                    }\r\n\r\n                    if(typeof window.customVariables.downloads[uuid] !== \"undefined\"){\r\n                        chunksDonePlus()\r\n                        setLoaded(downloadData.length)\r\n                        \r\n                        this.writeChunkToFile(file, dirObj, uuid, downloadIndex, downloadData, async (err) => {\r\n                            if(err){\r\n                                console.log(err)\r\n\r\n                                window.customVariables.downloadSemaphore.release()\r\n\r\n                                removeFromState()\r\n\r\n                                return this.spawnToast(language.get(this.state.lang, \"fileWriteError\", true, [\"__NAME__\"], [file.name]))\r\n                            }\r\n\r\n                            chunksWrittenPlus()\r\n\r\n                            try{\r\n                                let progress = ((window.customVariables.downloads[uuid].loaded / window.customVariables.downloads[uuid].size) * 100).toFixed(2)\r\n    \r\n                                if(progress >= 100){\r\n                                    progress = 100\r\n                                }\r\n    \r\n                                setProgress(progress)\r\n                            }\r\n                            catch(e){\r\n                                console.log(e)\r\n                            }\r\n\r\n                            try{\r\n                                if(window.customVariables.downloads[uuid].chunksWritten >= window.customVariables.downloads[uuid].chunks){\r\n                                    if(typeof window.customVariables.downloads[uuid].makeOffline !== \"undefined\"){\r\n                                        window.customVariables.offlineSavedFiles[file.uuid] = true\r\n    \r\n                                        let items = this.state.itemList\r\n                                        let windowItems = window.customVariables.itemList\r\n    \r\n                                        for(let i = 0; i < items.length; i++){\r\n                                            if(items[i].uuid == file.uuid){\r\n                                                items[i].offline = true\r\n                                            }\r\n                                        }\r\n    \r\n                                        for(let i = 0; i < windowItems.length; i++){\r\n                                            if(windowItems[i].uuid == file.uuid){\r\n                                                windowItems[i].offline = true\r\n                                            }\r\n                                        }\r\n    \r\n                                        this.setState({\r\n                                            itemList: items\r\n                                        })\r\n    \r\n                                        window.customVariables.itemList = windowItems\r\n                                        \r\n                                        if(typeof window.customVariables.cachedFiles[uuid] !== \"undefined\"){\r\n                                            window.customVariables.cachedFiles[uuid].offline = true\r\n                                        }\r\n                            \r\n                                        this.spawnToast(language.get(this.state.lang, \"fileIsNowAvailableOffline\", true, [\"__NAME__\"], [file.name]))\r\n    \r\n                                        removeFromState()\r\n    \r\n                                        window.customFunctions.saveOfflineSavedFiles()\r\n    \r\n                                        window.customVariables.downloadSemaphore.release()\r\n                                        \r\n                                        return this.forceUpdate()\r\n                                    }\r\n                                    else{\r\n                                        this.spawnToast(language.get(this.state.lang, \"fileDownloadDone\", true, [\"__NAME__\"], [file.name]))\r\n    \r\n                                        window.customVariables.downloadSemaphore.release()\r\n    \r\n                                        return removeFromState()\r\n                                    }\r\n                                }  \r\n                            }\r\n                            catch(e){\r\n                                console.log(e)\r\n                            }\r\n                        })\r\n                    }\r\n                })\r\n            }\r\n            else{\r\n                clearInterval(downloadInterval)\r\n            }\r\n        }, 100)\r\n    })\r\n}\r\n\r\nexport async function getThumbnail(file, thumbURL, ext){\r\n    return new Promise(async (resolve, reject) => {\r\n        if(Capacitor.isNative){\r\n            if(this.state.settings.onlyWifi){\r\n                let networkStatus = await Plugins.Network.getStatus()\r\n    \r\n                if(networkStatus.connectionType !== \"wifi\"){\r\n                    reject(\"only wifi\")\r\n\r\n                    return this.spawnToast(language.get(this.state.lang, \"onlyWifiError\"))\r\n                }\r\n            }\r\n        }\r\n        else{\r\n            return reject(\"not native\")\r\n        }\r\n\r\n        let dirObj = {\r\n            path: \"ThumbnailCache/\" + file.uuid,\r\n            directory: FilesystemDirectory.External\r\n        }\r\n\r\n        let videoExts = [\"mp4\", \"webm\", \"mov\", \"avi\", \"wmv\"]\r\n    \r\n        await window.customVariables.thumbnailSemaphore.acquire()\r\n\r\n        if(file.chunks > 16 && !videoExts.includes(ext)){\r\n            window.customVariables.thumbnailSemaphore.release()\r\n\r\n            return reject(\"too big\")\r\n        }\r\n\r\n        let thumbnailFileName = file.name\r\n\r\n        if(videoExts.includes(ext)){\r\n            let nameEx = file.name.split(\".\")\r\n\r\n            nameEx[nameEx.length - 1] = \"jpg\"\r\n\r\n            thumbnailFileName = nameEx.join(\".\")\r\n        }\r\n\r\n        if(typeof window.customVariables.thumbnailCache[file.uuid] == \"undefined\"){\r\n            if(thumbURL !== window.location.href){\r\n                window.customVariables.thumbnailSemaphore.release()\r\n\r\n                return reject(\"url changed\")\r\n            }\r\n\r\n            const writeThumbnail = async (arrayBuffer) => {\r\n                workers.convertArrayBufferToBase64(arrayBuffer, async (b64Data) => {\r\n                    try{\r\n                        await Plugins.Filesystem.writeFile({\r\n                            path: dirObj.path + \"/\" + thumbnailFileName,\r\n                            directory: dirObj.directory,\r\n                            data: b64Data,\r\n                            recursive: true\r\n                        })\r\n\r\n                        var uri = await Plugins.Filesystem.getUri({\r\n                            path: dirObj.path + \"/\" + thumbnailFileName,\r\n                            directory: dirObj.directory\r\n                        })\r\n                    }\r\n                    catch(e){\r\n                        window.customVariables.thumbnailSemaphore.release()\r\n\r\n                        return reject(e)\r\n                    }\r\n\r\n                    if(thumbURL !== window.location.href){\r\n                        window.customVariables.thumbnailSemaphore.release()\r\n        \r\n                        return reject(\"url changed\")\r\n                    }\r\n\r\n                    let imageURL = window.Ionic.WebView.convertFileSrc(uri.uri)\r\n\r\n                    window.customVariables.thumbnailBlobCache[file.uuid] = imageURL\r\n                    window.customVariables.thumbnailCache[file.uuid] = true\r\n\r\n                    window.customVariables.thumbnailSemaphore.release()\r\n\r\n                    return resolve(imageURL)\r\n                })\r\n            }\r\n\r\n            if(videoExts.includes(ext)){\r\n                this.downloadPreview(file, undefined, async (err, downloadData) => {\r\n                    if(err){\r\n                        window.customVariables.thumbnailSemaphore.release()\r\n    \r\n                        return reject(err)\r\n                    }\r\n\r\n                    downloadData = new File([new Blob([downloadData], {\r\n                        type: file.mime\r\n                    })], file.name, {\r\n                        lastModified: new Date(),\r\n                        type: file.mime\r\n                    })\r\n    \r\n                    try{\r\n                        var thumbnailData = await utils.getVideoCover(downloadData)\r\n                    }\r\n                    catch(e){\r\n                        window.customVariables.thumbnailSemaphore.release()\r\n    \r\n                        return reject(e)\r\n                    }\r\n\r\n                    thumbnailData = new File([thumbnailData], thumbnailFileName, {\r\n                        lastModified: new Date(),\r\n                        type: \"image/jpeg\"\r\n                    })\r\n\r\n                    try{\r\n                        var compressedImage = await imageCompression(thumbnailData, {\r\n                            maxWidthOrHeight: 200,\r\n                            useWebWorker: true\r\n                        })\r\n                    }\r\n                    catch(e){\r\n                        window.customVariables.thumbnailSemaphore.release()\r\n    \r\n                        return reject(e)\r\n                    }\r\n    \r\n                    let fileReader = new FileReader()\r\n    \r\n                    fileReader.onload = (e) => {\r\n                        let arrayBuffer = e.target.result\r\n    \r\n                        return writeThumbnail(arrayBuffer)\r\n                    }\r\n    \r\n                    fileReader.onerror = (err) => {\r\n                        window.customVariables.thumbnailSemaphore.release()\r\n    \r\n                        return reject(err)\r\n                    }\r\n    \r\n                    fileReader.readAsArrayBuffer(compressedImage)\r\n                }, 3)\r\n            }\r\n            else{\r\n                this.downloadPreview(file, undefined, async (err, data) => {\r\n                    if(err){\r\n                        window.customVariables.thumbnailSemaphore.release()\r\n    \r\n                        return reject(err)\r\n                    }\r\n    \r\n                    if(utils.canCompressThumbnail(ext)){\r\n                        data = new File([new Blob([data], {\r\n                            type: file.mime\r\n                        })], thumbnailFileName, {\r\n                            lastModified: new Date(),\r\n                            type: file.mime\r\n                        })\r\n        \r\n                        try{\r\n                            var compressedImage = await imageCompression(data, {\r\n                                maxWidthOrHeight: 200,\r\n                                useWebWorker: true\r\n                            })\r\n                        }\r\n                        catch(e){\r\n                            window.customVariables.thumbnailSemaphore.release()\r\n        \r\n                            return reject(e)\r\n                        }\r\n        \r\n                        let fileReader = new FileReader()\r\n        \r\n                        fileReader.onload = (e) => {\r\n                            let arrayBuffer = e.target.result\r\n        \r\n                            return writeThumbnail(arrayBuffer)\r\n                        }\r\n        \r\n                        fileReader.onerror = (err) => {\r\n                            window.customVariables.thumbnailSemaphore.release()\r\n        \r\n                            return reject(err)\r\n                        }\r\n        \r\n                        fileReader.readAsArrayBuffer(compressedImage)\r\n                    }\r\n                    else{\r\n                        return writeThumbnail(data)\r\n                    }\r\n                })\r\n            }\r\n        }\r\n        else{\r\n            try{\r\n                var uri = await Plugins.Filesystem.getUri({\r\n                    path: dirObj.path + \"/\" + thumbnailFileName,\r\n                    directory: dirObj.directory\r\n                })\r\n            }\r\n            catch(e){\r\n                window.customVariables.thumbnailSemaphore.release()\r\n\r\n                delete window.customVariables.thumbnailCache[file.uuid]\r\n\r\n                return reject(e)\r\n            }\r\n\r\n            if(thumbURL !== window.location.href){\r\n                window.customVariables.thumbnailSemaphore.release()\r\n\r\n                return reject(\"url changed\")\r\n            }\r\n\r\n            let imageURL = window.Ionic.WebView.convertFileSrc(uri.uri)\r\n\r\n            window.customVariables.thumbnailBlobCache[file.uuid] = imageURL\r\n            window.customVariables.thumbnailCache[file.uuid] = true\r\n\r\n            window.customVariables.thumbnailSemaphore.release()\r\n\r\n            return resolve(imageURL)\r\n        }\r\n    })\r\n}\r\n\r\nexport async function downloadPreview(file, progressCallback, callback, maxChunks = Infinity){\r\n    let dataArray = []\r\n    let currentIndex = -1\r\n    let currentWriteIndex = 0\r\n    let chunksDone = 0\r\n    \r\n    const write = (index, data, callback) => {\r\n        if(currentWriteIndex == index){\r\n            dataArray.push(data)\r\n\r\n            currentWriteIndex += 1\r\n            chunksDone += 1\r\n\r\n            if(typeof progressCallback == \"function\"){\r\n                progressCallback(chunksDone)\r\n            }\r\n\r\n            if(chunksDone == file.chunks || chunksDone == maxChunks){\r\n                return callback(null, utils.uInt8ArrayConcat(dataArray))\r\n            }\r\n        }\r\n        else{\r\n            return setTimeout(() => {\r\n                write(index, data, callback)\r\n            }, 50)\r\n        }\r\n    }\r\n\r\n    let downloadInterval = setInterval(() => {\r\n        currentIndex += 1\r\n\r\n        let thisIndex = currentIndex\r\n\r\n        if(thisIndex < file.chunks && thisIndex < maxChunks && !window.customVariables.stopGettingPreviewData){\r\n            this.downloadFileChunk(file, thisIndex, 0, 32, (err, downloadIndex, downloadData) => {\r\n                if(err){\r\n                    return callback(err)\r\n                }\r\n\r\n                write(downloadIndex, downloadData, callback)\r\n            })\r\n        }\r\n        else{\r\n            if(window.customVariables.stopGettingPreviewData){\r\n                window.customVariables.isGettingPreviewData = false\r\n                \r\n                callback(\"stopped\")\r\n            }\r\n\r\n            clearInterval(downloadInterval)\r\n        }\r\n    }, 100)\r\n}"]},"metadata":{},"sourceType":"module"}